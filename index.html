<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†è²¡ç­–åŠƒå°ˆæ¥­æœå‹™è·Ÿé€²</title>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --ink: #202124;
    --muted: #5f6368;
    --brand: #1a73e8;
    --border: #e0e3eb;
    --checked: #e6f3ff;

    /* Magnifier colors */
    --lens-stroke: #2f3b7c;
    --lens-fill:   #ffffff;
    --lens-gloss:  #e3e9ff;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang HK", "Heiti TC", "Microsoft JhengHei", sans-serif;
    background: var(--bg);
    color: var(--ink);
    padding: 28px 18px 40px;
  }
  .wrap { max-width: 980px; margin: 0 auto; }

  /* Export frame: ensures side margins in PNG/PDF */
  .export-frame {
    background: #fff;
    padding: 24px;                  /* reserved padding for exports */
    border: 1px solid #e8eaf3;
    border-radius: 12px;
  }

  /* Top info bar (Name + Date) */
  .info-bar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
    margin-bottom: 10px;
  }
  .name-field {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    flex-wrap: wrap;
  }
  .name-field label { color: #1f2a3a; }
  .name-input {
    flex: 1 1 auto;
    max-width: 320px;
    padding: 8px 10px;
    border: 1px solid #cfd6e7;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
  }

  /* Name mirror: hidden on screen, visible only during export */
  .name-mirror {
    display: none;
    min-height: 22px;
    padding: 0 2px;
    border-bottom: 1px dashed #cfd6e7;
    color: #1f2a3a;
    font-weight: 700;
    white-space: pre-wrap;
    word-break: break-word;
    max-width: 320px;
  }
  .name-mirror.placeholder { color: #9aa0a6; font-weight: 400; }
  .exporting .name-mirror { display: inline-block !important; }
  .exporting .name-input { display: none !important; }

  .date-field {
    font-size: 14px;
    color: #1f2a3a;
    font-weight: 700;
    padding: 8px 10px;
    border: 1px solid #cfd6e7;
    border-radius: 8px;
    background: #fff;
    min-width: 140px;
    text-align: right;
    white-space: nowrap;
  }

  /* ===== Header / Title (ICON + TEXT centered as a unit) ===== */
  .title-box {
    background: linear-gradient(135deg, #ffe9f0, #e8f0fe);
    border: 1px solid #d7deed;
    border-radius: 14px;
    padding: 18px 20px;
    margin-bottom: 22px;

    /* Stack group + subtitle, and center */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-align: center;
  }

  /* Group icon + title text so they always stick together */
  .title-group {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 12px; /* default overridden below to 4px (Option C) */
  }

  .title-icon {
    width: 68px;
    height: 68px;
    display: inline-block;
    margin: 0;
    margin-top: -2px;              /* slight baseline alignment tweak */
    flex: 0 0 auto;
  }
  .title-icon svg { display: block; width: 68px; height: 68px; }

  .main-title {
    margin: 0;
    font-size: 24px;
    font-weight: 900;
    line-height: 1.2;
    white-space: normal;
    word-break: keep-all;          /* better for CJK */
  }

  .subtitle-title {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
  }

  /* >>> Option C: bring icon + title closer (very tight) */
  .title-group { gap: 4px; }

  /* >>> Option A: nudge the title text up to align with icon */
  .title-group .main-title {
    transform: translateY(-2px);
  }
  @media (max-width: 480px) {
    .title-group .main-title {
      transform: translateY(-1px);
    }
  }

  /* Grid: default desktop = 3 columns */
  .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }

  /* Card */
  .card {
    position: relative; background: var(--card); border: 2px solid var(--border);
    border-radius: 12px; padding: 14px; min-height: 150px;
    display: grid; grid-template-columns: 68px 1fr;
    grid-template-rows: auto auto 1fr;
    grid-template-areas: "icon title" "icon subtitle" "icon footer";
    column-gap: 12px; cursor: pointer;
    transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
  }
  .card:hover { border-color: #c6d2f7; box-shadow: 0 4px 14px rgba(0,0,0,.06); }
  .card.checked {
    border-color: var(--brand); background: var(--checked);
    box-shadow: 0 6px 16px rgba(26,115,232,.12);
  }
  .check { position: absolute; inset: 0; opacity: 0; pointer-events: none; }
  .icon {
    grid-area: icon; width: 68px; height: 68px;
    border: 1px solid var(--border);
    border-radius: 10px;
    display: grid; place-items: center; overflow: hidden; background: #fafbff;
  }
  .emoji { font-size: 36px; line-height: 1; }

  .title { grid-area: title; font-weight: 800; color: #1f3b2d; font-size: 16px; line-height: 1.25; margin-top: 2px; }
  .subtitle { grid-area: subtitle; color: #2a6f37; font-weight: 600; font-size: 13px; margin-top: 6px; }
  .footer { grid-area: footer; margin-top: 10px; color: var(--muted); font-size: 12px; }

  .tick {
    position: absolute; top: 10px; right: 10px;
    display: inline-flex; align-items: center; gap: 6px;
    background: #e8f5e9; color: #0c6b2e; border: 1px solid #bfe8c9;
    border-radius: 999px; padding: 4px 8px; font-size: 12px;
    opacity: 0; transform: translateY(-4px); transition: all .18s ease;
  }
  .card.checked .tick { opacity: 1; transform: translateY(0); }

  .note { margin-top: 14px; color: var(--muted); font-size: 12px; text-align: center; }
  .actions { display: flex; gap: 10px; justify-content: center; margin-top: 18px; }
  .btn { border: 1px solid #cfd6e7; background: #fff; color: #1a2a3a; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--brand); border-color: var(--brand); color: #fff; }

  @media print { .actions, .note { display: none !important; } body { background: #fff; padding: 0; } }

  /* ===== Mobile & Tablet responsive rules per your spec ===== */

  /* MOBILE PORTRAIT â†’ 1 per row (6 rows total for 6 cards) */
  @media (max-width: 480px) and (orientation: portrait) {
    body { padding: 16px 12px 28px; }

    .export-frame {
      padding: 16px;
      border-radius: 10px;
    }

    .info-bar {
      grid-template-columns: 1fr;
      row-gap: 8px;
    }
    .date-field { justify-self: start; }
    .name-field { gap: 6px; }
    .name-input { max-width: 100%; width: 100%; }

    .title-box { gap: 8px; padding: 14px 12px; }
    .title-icon { width: 54px; height: 54px; margin-top: -2px; }
    .title-icon svg { width: 54px; height: 54px; }
    .main-title { font-size: 20px; line-height: 1.25; }
    .subtitle-title { font-size: 13px; }

    /* âœ… MOBILE PORTRAIT GRID = 1 card per row */
    .grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .card {
      grid-template-columns: 56px 1fr;
      padding: 12px;
      min-height: 140px;
    }
    .icon { width: 56px; height: 56px; }
    .icon .emoji { font-size: 24px; }

    /* Ensure Card 6 two-emoji pair always fits */
    [data-id="retirement-risk"] .icon .emoji {
      font-size: 22px !important;
      letter-spacing: -6px;
      line-height: 1;
    }
  }

  /* MOBILE LANDSCAPE â†’ show DESKTOP layout (3 per row) */
  @media (max-width: 480px) and (orientation: landscape) {
    .grid { grid-template-columns: repeat(3, 1fr); }
  }

  /* TABLET PORTRAIT (481â€“1024px) â†’ 2 per row */
  @media (min-width: 481px) and (max-width: 1024px) and (orientation: portrait) {
    .grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* TABLET LANDSCAPE â†’ no rule needed (falls back to desktop 3 per row) */
</style>
</head>
<body>
  <div class="wrap">

    <!-- Export frame adds padding so PNG/PDF have side margins -->
    <div class="export-frame" id="exportFrame">
      <!-- Capture area (everything inside is exported) -->
      <div id="captureArea">
        <!-- Name + Date bar -->
        <div class="info-bar">
          <div class="name-field">
            <label for="clientName">å®¢æˆ¶å§“åï¼š</label>
            <!-- Mirror (left of input) â€” hidden on screen, shown only in export -->
            <span id="nameMirror" class="name-mirror placeholder">ï¼ˆè«‹è¼¸å…¥å§“åï¼‰</span>
            <!-- Input (screen only) -->
            <input id="clientName" class="name-input" type="text" placeholder="è«‹è¼¸å…¥å§“å" />
          </div>
          <div id="todayDate" class="date-field">â€”</div>
        </div>

        <!-- Title: icon + title stick together; subtitle under the group -->
        <div class="title-box">
          <div class="title-group">
            <div class="title-icon" aria-hidden="true">
              <!-- viewBox 64 x 64, rendered at 68px -->
              <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                <title>Magnifying glass</title>

                <!-- Bigger circle (r=20). Center at (cx, cy) = (40, 26). -->
                <circle cx="40" cy="26" r="20"
                        fill="var(--lens-fill)"
                        stroke="var(--lens-stroke)" stroke-width="3.5"/>
                <!-- Highlight -->
                <circle cx="34" cy="19.5" r="5" fill="var(--lens-gloss)"/>

                <!-- ã€Œç†ã€ perfectly centered in the lens -->
                <text x="40" y="26"
                      text-anchor="middle"
                      dominant-baseline="middle"
                      font-family="Microsoft JhengHei, PingFang HK, Noto Sans CJK, Arial"
                      font-size="24" font-weight="900" fill="#2f3b7c">ç†</text>

                <!-- SHORTER handle on the LEFT -->
                <line x1="26" y1="36" x2="15" y2="47"
                      stroke="var(--lens-stroke)" stroke-width="5" stroke-linecap="round"/>
              </svg>
            </div>

            <h1 class="main-title">è²¡ç­–åŠƒå°ˆæ¥­æœå‹™è·Ÿé€²</h1>
          </div>

          <p class="subtitle-title">è«‹é¸æ“‡æ‚¨é—œæ³¨çš„é …ç›®ï¼ˆé»æ“Šå¡ç‰‡å³å¯å‹¾é¸ï¼å–æ¶ˆï¼‰</p>
        </div>

        <!-- Grid (desktop default 3 x 2), switches per media queries -->
        <form id="checklist" class="grid">
          <!-- Card 1 -->
          <label class="card" data-id="emergency-cash">
            <input class="check" type="checkbox" name="emergency-cash" />
            <div class="icon"><span class="emoji" aria-hidden="true">ğŸ’°</span></div>
            <div class="title">æ‡‰æ€¥ç¾é‡‘</div>
            <div class="subtitle">è¶³å¤ æä¾›ä¸€å¹´æ—¥å¸¸æ”¯å‡º</div>
            <div class="footer">å»ºç«‹ç·Šæ€¥å‚™ç”¨é‡‘ï¼Œæå‡æŠ—é¢¨éšªèƒ½åŠ›</div>
            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- Card 2 -->
          <label class="card" data-id="health-protection">
            <input class="check" type="checkbox" name="health-protection" />
            <div class="icon"><span class="emoji" aria-hidden="true">ğŸ©º</span></div>
            <div class="title">é†«ç™‚åŠäººå£½ä¿éšœ</div>
            <div class="subtitle">æ‡‰ä»˜è¡æ“Šå¸¶ä¾†çš„é†«ç™‚åŠå®¶åº­è®Šæ•…</div>
            <div class="footer">é†«ç™‚ä¿éšªï¼‹å£½éšªé…ç½®ï¼Œå®ˆè­·å®¶åº­</div>
            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- Card 3 -->
          <label class="card" data-id="premium-offset">
            <input class="check" type="checkbox" name="premium-offset" />
            <div class="icon"><span class="emoji" aria-hidden="true">ğŸ“ˆ</span></div>
            <div class="title">ä¿è²»å°æ²–æ–¹æ¡ˆ</div>
            <div class="subtitle">æ‡‰ä»˜ä¿è²»èª¿æ•´åŠå¢åŠ </div>
            <div class="footer">è³‡ç”¢é…ç½®ä»¥å¹³æ»‘é•·æœŸä¿è²»å£“åŠ›</div>
            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- Card 4 -->
          <label class="card" data-id="annuity-income">
            <input class="check" type="checkbox" name="annuity-income" />
            <div class="icon"><span class="emoji" aria-hidden="true">ğŸ </span></div>
            <div class="title">å®šæœŸå¹´é‡‘æ”¶å…¥</div>
            <div class="subtitle">æä¾›ç©©å®šç”Ÿæ´»å…¥æ¯</div>
            <div class="footer">é€€ä¼‘ç¾é‡‘æµè¨ˆåŠƒèˆ‡é€šè„¹å°æ²–</div>
            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- Card 5 -->
          <label class="card" data-id="legacy-planning">
            <input class="check" type="checkbox" name="legacy-planning" />
            <div class="icon"><span class="emoji" aria-hidden="true">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span></div>
            <div class="title">æ„›çš„è³‡ç”¢å‚³æ‰¿</div>
            <div class="subtitle">è²¡å¯Œå¢å€¼å‚³æ‰¿è‡³ç¬¬äºŒä»£</div>
            <div class="footer">ä¿¡è¨—ï¼éºå›‘ï¼å£½éšªå‚³æ‰¿å®‰æ’</div>
            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- Card 6 -->
          <label class="card" data-id="retirement-risk">
            <input class="check" type="checkbox" name="retirement-risk" />
            <div class="icon"><span class="emoji" aria-hidden="true" style="font-size:26px; letter-spacing:-6px; line-height:1;">ğŸ‘µğŸ‘´</span></div>
            <div class="title">é€€ã€Œæ†‚ã€é¢¨éšª</div>
            <div class="subtitle">æ‡‰ä»˜é•·å£½ç”Ÿæ´»é–‹æ”¯</div>
            <div class="footer">é•·å£½é¢¨éšªç®¡ç†èˆ‡é†«ç™‚è­·ç†æº–å‚™</div>
            <div class="tick">âœ“ å·²é¸</div>
          </label>
        </form>
      </div>
    </div>

    <!-- Buttons (not captured) -->
    <div class="actions">
      <button class="btn" type="button" id="clearBtn">æ¸…é™¤é¸æ“‡</button>
      <button class="btn" type="button" id="pngBtn">å°å‡º PNG</button>
      <button class="btn primary" type="button" id="pdfBtn">å°å‡º PDF</button>
    </div>

    <p class="note">æç¤ºï¼šä½ çš„é¸æ“‡æœƒè‡ªå‹•å„²å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ä¸­ã€‚è«‹ç¢ºä¿ä¸‹æ¬¡ä½¿ç”¨å‰æ¸…é™¤é¸é …ã€‚</p>
  </div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // Wait until DOM and external libraries are ready
  window.addEventListener('load', () => {
    const form = document.getElementById('checklist');
    const exportFrame = document.getElementById('exportFrame'); // capture this to keep side spacing
    const pngBtn = document.getElementById('pngBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const clearBtn = document.getElementById('clearBtn');
    const clientName = document.getElementById('clientName');
    const nameMirror = document.getElementById('nameMirror');
    const todayDate = document.getElementById('todayDate');

    const KEY = 'fp_checklist_v1';
    const KEY_NAME = 'fp_client_name';
    const SCALE = 2; // Increase to 3 for sharper output (larger files)

    // Fill today's date (yyyy/mm/dd for display; yyyymmdd for filename)
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    todayDate.textContent = `${yyyy}/${mm}/${dd}`;
    const yyyymmdd = `${yyyy}${mm}${dd}`;

    // Restore saved name and sync mirror
    clientName.value = localStorage.getItem(KEY_NAME) || '';
    syncNameMirror();
    clientName.addEventListener('input', () => {
      localStorage.setItem(KEY_NAME, clientName.value);
      syncNameMirror();
    });

    function syncNameMirror(){
      const v = clientName.value.trim();
      if (v) {
        nameMirror.textContent = v;
        nameMirror.classList.remove('placeholder');
      } else {
        nameMirror.textContent = 'ï¼ˆè«‹è¼¸å…¥å§“åï¼‰';
        nameMirror.classList.add('placeholder');
      }
    }

    // Ensure libraries loaded
    if (typeof window.html2canvas !== 'function') {
      alert('html2canvas è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– CDNã€‚');
      return;
    }
    if (!window.jspdf || typeof window.jspdf.jsPDF !== 'function') {
      alert('jsPDF è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– CDNã€‚');
      return;
    }

    // Restore saved checkbox state
    const saved = JSON.parse(localStorage.getItem(KEY) || '{}');
    [...form.querySelectorAll('.card')].forEach(card => {
      const id = card.dataset.id;
      const input = card.querySelector('.check');
      const isChecked = !!saved[id];
      input.checked = isChecked;
      card.classList.toggle('checked', isChecked);
      input.addEventListener('change', () => {
        card.classList.toggle('checked', input.checked);
        persist();
      });
    });

    function persist(){
      const state = {};
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const input = card.querySelector('.check');
        state[id] = input.checked;
      });
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    // CLEAR: also clear client name & saved name
    clearBtn.addEventListener('click', () => {
      [...form.querySelectorAll('.card')].forEach(card => {
        const input = card.querySelector('.check');
        input.checked = false;
        card.classList.remove('checked');
      });
      persist();
      clientName.value = '';
      localStorage.removeItem(KEY_NAME);
      syncNameMirror();
      clientName.focus();
    });

    // Toggle export mode: hide input, show mirror (so it captures cleanly)
    async function captureWithExporting(fn){
      exportFrame.classList.add('exporting');
      clientName.blur(); // guarantee paint
      try {
        await fn();
      } finally {
        exportFrame.classList.remove('exporting');
      }
    }

    // Filename helper
    function safeFilename(base){
      return base.replace(/[\\/:*?"<>|]/g, '_').replace(/\s+/g, ' ').trim();
    }

    // Export as PNG
    pngBtn.addEventListener('click', () => {
      captureWithExporting(async () => {
        const canvas = await html2canvas(exportFrame, {
          backgroundColor: '#ffffff',
          scale: SCALE,
          useCORS: true,
          logging: false
        });
        canvas.toBlob((blob) => {
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const client = (clientName.value.trim() || 'é¸é …æˆªåœ–');
          a.href = url;
          a.download = `${safeFilename(client)}_${yyyymmdd}.png`;
          a.click();
          URL.revokeObjectURL(url);
        }, 'image/png');
      });
    });

    // Export as PDF
    pdfBtn.addEventListener('click', () => {
      captureWithExporting(async () => {
        const canvas = await html2canvas(exportFrame, {
          backgroundColor: '#ffffff',
          scale: SCALE,
          useCORS: true,
          logging: false
        });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;

        // Orientation based on canvas
        const isLandscape = canvas.width > canvas.height;
        const pdf = new jsPDF({
          orientation: isLandscape ? 'landscape' : 'portrait',
          unit: 'pt',
          format: 'a4'
        });

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        // Keep margins on paper: scale to 90% of page
        const maxW = pageW * 0.90;
        const maxH = pageH * 0.90;
        const ratio = Math.min(maxW / canvas.width, maxH / canvas.height);
        const imgW = canvas.width * ratio;
        const imgH = canvas.height * ratio;
        const x = (pageW - imgW) / 2;
        const y = (pageH - imgH) / 2;

        pdf.addImage(imgData, 'PNG', x, y, imgW, imgH);

        const client = (clientName.value.trim() || 'é¸é …æˆªåœ–');
        pdf.save(`${safeFilename(client)}_${yyyymmdd}.pdf`);
      });
    });

    /* === Sidebar (hidden by default) + Save Profiles â€” additive === */

    /** 1) Inject CSS: off-canvas by default, toggle button moves to top-right on mobile (Option 2) */
    const __sidebarCSS = `
    /* Sidebar shell: hidden off-canvas by default */
    .client-sidebar {
      position: fixed; inset: 0 auto 0 0; width: 260px;
      background: #ffffff; border-right: 1px solid #e8eaf3;
      padding: 16px 12px; overflow: auto;
      box-shadow: 0 0 10px rgba(0,0,0,.06);
      transform: translateX(-100%); transition: transform .2s ease;
      z-index: 9;
    }
    body.sidebar-open .client-sidebar { transform: translateX(0); }

    .client-sidebar h2 { margin: 4px 8px 8px; font-size: 14px; letter-spacing: .5px; color:#1f2a3a; }
    .client-sidebar .search {
      width:100%; padding:8px 10px; border:1px solid #cfd6e7; border-radius:8px; margin: 8px 6px 12px; font-size: 13px;
    }
    .client-list { list-style: none; margin: 0; padding: 0 6px; display: grid; gap: 8px; }
    .client-item {
      border: 1px solid #e0e3eb; border-radius:10px; padding: 10px; background:#fff;
      display:flex; align-items: center; justify-content: space-between; gap:8px;
    }
    .client-item .meta { display:flex; flex-direction: column; min-width: 0; }
    .client-item .name { font-weight: 700; font-size: 14px; color:#1f2a3a; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .client-item .date { font-size: 12px; color:#5f6368; }
    .client-item .actions { display:flex; gap:6px; }
    .client-item .btn-xs {
      border:1px solid #cfd6e7; background:#fff; color:#1a2a3a;
      padding:4px 8px; border-radius: 8px; font-size:12px; cursor:pointer;
    }
    .client-empty { padding: 10px 8px; color:#5f6368; font-size: 12px; }

    /* Toggle button: default top-left, with safe-area insets */
    .sidebar-toggle {
      position: fixed;
      left: max(10px, env(safe-area-inset-left, 0px) + 10px);
      top:  max(10px, env(safe-area-inset-top, 0px) + 10px);
      z-index: 10;
      border: 1px solid #cfd6e7; background:#fff; padding:8px 12px; border-radius:8px;
      font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
    }

    /* Option 2: On mobile, move toggle to top-right (avoid overlapping name field) */
    @media (max-width: 480px) {
      .sidebar-toggle {
        left: auto;
        right: max(10px, env(safe-area-inset-right, 0px) + 10px);
        top:  max(10px, env(safe-area-inset-top, 0px) + 10px);
      }
      .client-sidebar { width: 85vw; }
    }
    `;
    const __styleEl = document.createElement('style');
    __styleEl.textContent = __sidebarCSS;
    document.head.appendChild(__styleEl);

    /** 2) Build the sidebar (outside export area so it never gets captured) */
    const __sidebar = document.createElement('aside');
    __sidebar.className = 'client-sidebar';
    __sidebar.setAttribute('aria-hidden', 'true');
    __sidebar.innerHTML = `
      <h2>å®¢æˆ¶åˆ—è¡¨</h2>
      <input type="search" class="search" placeholder="æœå°‹å§“åâ€¦" aria-label="æœå°‹å§“å" />
      <ul class="client-list" id="clientList"></ul>
      <div class="client-empty" id="clientEmpty" style="display:none;">å°šæœªå„²å­˜ä»»ä½•å®¢æˆ¶ã€‚</div>
    `;
    document.body.appendChild(__sidebar);

    /** 3) Toggle button (always visible) */
    const __toggle = document.createElement('button');
    __toggle.className = 'sidebar-toggle';
    __toggle.type = 'button';
    __toggle.setAttribute('aria-expanded', 'false');
    __toggle.setAttribute('aria-controls', 'clientList');
    __toggle.innerHTML = 'â˜° å®¢æˆ¶';
    __toggle.addEventListener('click', () => {
      const open = document.body.classList.toggle('sidebar-open');
      __toggle.setAttribute('aria-expanded', String(open));
      __sidebar.setAttribute('aria-hidden', String(!open));
    });
    document.body.appendChild(__toggle);

    /** 4) Add a "Save" button next to your export buttons (as 2nd from left) */
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn';
    saveBtn.type = 'button';
    saveBtn.id = 'saveBtn';
    saveBtn.textContent = 'å„²å­˜è³‡æ–™';
    // Insert before PNG button â†’ order: æ¸…é™¤é¸æ“‡ | å„²å­˜è³‡æ–™ | å°å‡º PNG | å°å‡º PDF
    pngBtn.insertAdjacentElement('beforebegin', saveBtn);

    /** 5) Profiles storage helpers */
    const PROFILES_KEY = 'fp_profiles_v1';

    function __loadProfiles(){
      try { return JSON.parse(localStorage.getItem(PROFILES_KEY)) || []; }
      catch(e){ return []; }
    }
    function __storeProfiles(list){
      localStorage.setItem(PROFILES_KEY, JSON.stringify(list));
    }
    function __readCurrentState(){
      const state = {};
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const input = card.querySelector('.check');
        state[id] = !!input.checked;
      });
      return state;
    }
    function __applyState(state){
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const input = card.querySelector('.check');
        const checked = !!state[id];
        input.checked = checked;
        card.classList.toggle('checked', checked);
      });
      // Keep your original localStorage KEY in sync
      persist();
    }
    function __formatDT(d = new Date()){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mm}`;
    }

    /** 6) Save current as (create or overwrite by name) */
    function __saveCurrentProfile(){
      const name = clientName.value.trim();
      if(!name){
        alert('è«‹å…ˆè¼¸å…¥å®¢æˆ¶å§“åå†å„²å­˜ã€‚');
        clientName.focus();
        return;
      }
      const profiles = __loadProfiles();
      const idx = profiles.findIndex(p => p.name === name);
      const profile = {
        id: idx >= 0 ? profiles[idx].id : `p_${Date.now()}`,
        name,
        state: __readCurrentState(),
        savedAt: __formatDT()
      };
      if(idx >= 0){
        profiles[idx] = profile; // overwrite
      } else {
        profiles.unshift(profile); // newest first
      }
      __storeProfiles(profiles);
      localStorage.setItem(KEY_NAME, name);
      __renderClientList();
    }

    /** 7) Load / Delete handlers */
    function __loadProfileById(id){
      const profiles = __loadProfiles();
      const p = profiles.find(x => x.id === id);
      if(!p) return;
      clientName.value = p.name;
      localStorage.setItem(KEY_NAME, p.name);
      syncNameMirror();
      __applyState(p.state);
      document.body.classList.remove('sidebar-open');
      __toggle.setAttribute('aria-expanded', 'false');
      __sidebar.setAttribute('aria-hidden', 'true');
    }
    function __deleteProfile(id){
      const profiles = __loadProfiles().filter(p => p.id !== id);
      __storeProfiles(profiles);
      __renderClientList();
    }

    /** 8) Render sidebar list + search */
    function __renderClientList(filterText = ''){
      const listEl = document.getElementById('clientList');
      const emptyEl = document.getElementById('clientEmpty');
      const profiles = __loadProfiles();
      const q = filterText.trim().toLowerCase();
      const filtered = q ? profiles.filter(p => p.name.toLowerCase().includes(q)) : profiles;

      listEl.innerHTML = '';
      if(filtered.length === 0){
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      filtered.forEach(p => {
        const li = document.createElement('li');
        li.className = 'client-item';
        li.innerHTML = `
          <div class="meta">
            <div class="name" title="${p.name}">${p.name}</div>
            <div class="date">ä¸Šæ¬¡å„²å­˜ï¼š${p.savedAt}</div>
          </div>
          <div class="actions">
            <button class="btn-xs load">è¼‰å…¥</button>
            <button class="btn-xs del" title="åˆªé™¤">åˆªé™¤</button>
          </div>
        `;
        li.querySelector('.load').addEventListener('click', () => __loadProfileById(p.id));
        li.querySelector('.del').addEventListener('click', () => {
          if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${p.name}ã€çš„è³‡æ–™ï¼Ÿ`)){
            __deleteProfile(p.id);
          }
        });
        listEl.appendChild(li);
      });
    }

    /** 9) Wire up Save + Search + initial render */
    saveBtn.addEventListener('click', __saveCurrentProfile);
    __sidebar.querySelector('.search').addEventListener('input', (e) => {
      __renderClientList(e.target.value);
    });
    __renderClientList();

    /** 10) Quality-of-life: close sidebar before exporting (capture-phase) & Esc key */
    const __closeSidebar = () => {
      if (document.body.classList.contains('sidebar-open')) {
        document.body.classList.remove('sidebar-open');
        __toggle.setAttribute('aria-expanded', 'false');
        __sidebar.setAttribute('aria-hidden', 'true');
      }
    };
    // Ensure sidebar is closed BEFORE your original PNG/PDF handlers run
    pngBtn.addEventListener('click', __closeSidebar, true);
    pdfBtn.addEventListener('click', __closeSidebar, true);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') __closeSidebar();
    });

  });
</script>
</body>
</html>






