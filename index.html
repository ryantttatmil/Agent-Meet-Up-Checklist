
<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†è²¡ç­–åŠƒå°ˆæ¥­æœå‹™è·Ÿé€²</title>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --ink: #202124;
    --muted: #5f6368;
    --brand: #1a73e8;
    --border: #e0e3eb;
    --checked: #e6f3ff;

    /* Deficit (ä¸è¶³ï¼) theme */
    --deficit-border: #d93025;
    --deficit-bg: #fde8e6;

    /* Magnifier colors */
    --lens-stroke: #2f3b7c;
    --lens-fill:   #ffffff;
    --lens-gloss:  #e3e9ff;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang HK", "Heiti TC", "Microsoft JhengHei", sans-serif;
    background: var(--bg);
    color: var(--ink);
    padding: 28px 18px 40px;
  }
  .wrap { max-width: 980px; margin: 0 auto; }

  /* Export frame */
  .export-frame {
    background: #fff;
    padding: 24px;
    border: 1px solid #e8eaf3;
    border-radius: 12px;
  }

  /* Top info bar (Name + Date) */
  .info-bar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
    margin-bottom: 10px;
  }
  .name-field {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    flex-wrap: wrap;
  }
  .name-field label { color: #1f2a3a; }

  /* Inputs (Name/Age/Gender share same base style) */
  .name-input,
  .age-input,
  .gender-select {
    padding: 8px 10px;
    border: 1px solid #cfd6e7;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
  }

  .name-input {
    flex: 1 1 auto;
    max-width: 320px;
  }
  .age-input{
    width: 96px;
  }
  .gender-select{
    width: 150px;
  }

  /* Mirrors (export only) */
  .name-mirror,
  .age-mirror,
  .gender-mirror {
    display: none;
    min-height: 22px;
    padding: 0 2px;
    border-bottom: 1px dashed #cfd6e7;
    color: #1f2a3a;
    font-weight: 700;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .name-mirror { max-width: 320px; }
  .age-mirror  { min-width: 54px; }
  .gender-mirror { min-width: 72px; }

  .name-mirror.placeholder,
  .age-mirror.placeholder,
  .gender-mirror.placeholder { color: #9aa0a6; font-weight: 400; }

  .exporting .name-mirror,
  .exporting .age-mirror,
  .exporting .gender-mirror { display: inline-block !important; }

  .exporting .name-input,
  .exporting .age-input,
  .exporting .gender-select { display: none !important; }

  .date-field {
    font-size: 14px;
    color: #1f2a3a;
    font-weight: 700;
    padding: 8px 10px;
    border: 1px solid #cfd6e7;
    border-radius: 8px;
    background: #fff;
    min-width: 140px;
    text-align: right;
    white-space: nowrap;
  }

  /* ===== Header / Title (ICON + TEXT centered as a unit) ===== */
  .title-box {
    background: linear-gradient(135deg, #ffe9f0, #e8f0fe);
    border: 1px solid #d7deed;
    border-radius: 14px;
    padding: 18px 20px;
    margin-bottom: 22px;

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
  }

  .title-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px; /* tight */
  }

  .title-icon { width: 68px; height: 68px; margin-top: 12px; flex: 0 0 auto; }
  .title-icon svg { display: block; width: 68px; height: 68px; }

  .main-title {
    margin: 0;
    font-size: 24px;
    font-weight: 900;
    line-height: 1.2;
    word-break: keep-all;
    transform: translateY(-2px);
  }
  @media (max-width: 480px) {
    .main-title { transform: translateY(-1px); }
  }

  .subtitle-title { margin: 0; color: var(--muted); font-size: 14px; }

  /* Grid: default desktop = 3 columns */
  .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }

  /* Card */
  .card {
    position: relative;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    min-height: 150px;

    display: grid;
    grid-template-columns: 68px minmax(0, 1fr);
    grid-template-rows: auto auto 1fr;
    grid-template-areas: "icon title" "icon subtitle" "icon footer";
    column-gap: 12px;
    cursor: pointer;
    transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;

    max-width: 100%;
    overflow: hidden;
    box-sizing: border-box;
  }
  .card:hover { border-color: #c6d2f7; box-shadow: 0 4px 14px rgba(0,0,0,.06); }
  .card.checked { border-color: var(--brand); background: var(--checked); box-shadow: 0 6px 16px rgba(26,115,232,.12); }

  /* ğŸ”´ Deficit (ä¸è¶³ï¼) state */
  .card.deficit {
    border-color: var(--deficit-border) !important;
    background: var(--deficit-bg) !important;
    box-shadow: 0 6px 16px rgba(217,48,37,.12);
  }

  .check { position: absolute; inset: 0; opacity: 0; pointer-events: none; }

  .icon {
    grid-area: icon;
    width: 68px; height: 68px;
    border: 1px solid var(--border);
    border-radius: 10px;
    display: grid; place-items: center; overflow: hidden; background: #fafbff;
    min-width: 0;
  }
  .emoji { font-size: 36px; line-height: 1; }

  .title { grid-area: title; font-weight: 800; color: #1f3b2d; font-size: 16px; line-height: 1.25; margin-top: 2px; min-width: 0; }
  .subtitle { grid-area: subtitle; color: #2a6f37; font-weight: 600; font-size: 13px; margin-top: 6px; min-width: 0; }
  .footer { grid-area: footer; margin-top: 10px; color: var(--muted); font-size: 12px; min-width: 0; }

  .tick {
    position: absolute; top: 10px; right: 10px;
    display: inline-flex; align-items: center; gap: 6px;
    background: #e8f5e9; color: #0c6b2e; border: 1px solid #bfe8c9;
    border-radius: 999px; padding: 4px 8px; font-size: 12px;
    opacity: 0; transform: translateY(-4px); transition: all .18s ease;
  }
  .card.checked .tick { opacity: 1; transform: translateY(0); }

  .note { margin-top: 14px; color: var(--muted); font-size: 12px; text-align: center; }
  .actions { display: flex; gap: 10px; justify-content: center; margin-top: 18px; }
  .btn { border: 1px solid #cfd6e7; background: #fff; color: #1a2a3a; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--brand); border-color: var(--brand); color: #fff; }

  @media print { .actions, .note { display: none !important; } body { background: #fff; padding: 0; } }

  /* ===== Money area ===== */
  .money { grid-column: 1 / -1; margin-top: 8px; width: 100%; min-width: 0; }

  /* Row above the input: left = é‡‘é¡ toggle, right = ä¸è¶³ï¼ toggle */
  .money .money-header {
    display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%; min-width: 0;
  }

  .money .money-toggle,
  .money .deficit-toggle {
    border: 1px solid #cfd6e7;
    background: #fff;
    color: #1a2a3a;
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    flex: 0 0 auto;
  }
  .money .deficit-toggle[aria-pressed="true"] {
    background: var(--deficit-border);
    border-color: var(--deficit-border);
    color: #fff;
  }

  .money .money-box { display: none; margin-top: 8px; width: 100%; max-width: 100%; overflow: hidden; }
  .money .money-box.open { display: block; }

  .money .money-field {
    display: flex; align-items: center; gap: 8px;
    border: 1px solid #cfd6e7; border-radius: 8px; padding: 6px 8px; background: #fff;
    width: 100%; max-width: 100%; min-width: 0; box-sizing: border-box;
  }
  .money .currency-select {
    border: 1px solid #cfd6e7; border-radius: 6px; padding: 4px 8px; font-size: 12px; background: #fff; color: #1a2a3a;
    flex: 0 0 auto; max-width: 30%;
  }
  .money .money-input { flex: 1 1 auto; min-width: 0; width: 100%; border: 0; outline: none; font-size: 14px; box-sizing: border-box; }

  .money, .money * { pointer-events: auto; } /* allow inputs inside label */

  /* Containment guards */
  .wrap, .export-frame, .grid { max-width: 100%; overflow-x: hidden; }

  @media (max-width: 480px) and (orientation: portrait) {
    .card {
      grid-template-columns: 56px minmax(0, 1fr);
      padding: 12px; min-height: 140px;
    }
    .icon { width: 56px; height: 56px; }
    .icon .emoji { font-size: 24px; }
  }

  /* ===== Mobile grid rules ===== */
  @media (max-width: 480px) and (orientation: portrait) {
    body { padding: 16px 12px 28px; }
    .export-frame { padding: 16px; border-radius: 10px; }
    .info-bar { grid-template-columns: 1fr; row-gap: 8px; }
    .date-field { justify-self: start; }
    .name-field { gap: 6px; }

    .name-input { max-width: 100%; width: 100%; }
    .age-input { width: 100px; }
    .gender-select { width: 160px; }

    .title-box { gap: 8px; padding: 14px 12px; }
    .title-icon { width: 54px; height: 54px; margin-top: 12px; }
    .title-icon svg { width: 54px; height: 54px; }
    .main-title { font-size: 20px; line-height: 1.25; }
    .subtitle-title { font-size: 13px; }
    .grid { grid-template-columns: 1fr; gap: 22px; }
    [data-id="retirement-risk"] .icon .emoji { font-size: 22px !important; letter-spacing: -6px; line-height: 1; }
  }
  @media (max-width: 480px) and (orientation: landscape) { .grid { grid-template-columns: repeat(3, 1fr); } }
  @media (min-width: 481px) and (max-width: 1024px) and (orientation: portrait) { .grid { grid-template-columns: repeat(2, 1fr); } }
</style>
</head>

<body>
  <div class="wrap">

    <div class="export-frame" id="exportFrame">
      <div id="captureArea">
        <!-- Name + Date bar -->
        <div class="info-bar">
          <div class="name-field">
            <label for="clientName">å®¢æˆ¶å§“åï¼š</label>
            <span id="nameMirror" class="name-mirror placeholder">ï¼ˆè«‹è¼¸å…¥å§“åï¼‰</span>
            <input id="clientName" class="name-input" type="text" placeholder="è«‹è¼¸å…¥å§“å" />

            <!-- âœ… NEW: Age -->
            <label for="clientAge">å¹´é½¡ï¼š</label>
            <span id="ageMirror" class="age-mirror placeholder">ï¼ˆâ€”ï¼‰</span>
            <input id="clientAge" class="age-input" type="number" min="0" max="120" inputmode="numeric" placeholder="ä¾‹ï¼š35" />

            <!-- âœ… NEW: Gender -->
            <label for="clientGender">æ€§åˆ¥ï¼š</label>
            <span id="genderMirror" class="gender-mirror placeholder">ï¼ˆè«‹é¸æ“‡ï¼‰</span>
            <select id="clientGender" class="gender-select">
              <option value="" selected disabled>è«‹é¸æ“‡</option>
              <option value="ç”·">ç”·</option>
              <option value="å¥³">å¥³</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
              <option value="ä¸é¡˜é€éœ²">ä¸é¡˜é€éœ²</option>
            </select>
          </div>

          <div id="todayDate" class="date-field">â€”</div>
        </div>

        <!-- Title -->
        <div class="title-box">
          <div class="title-group">
            <div class="title-icon" aria-hidden="true">
              <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                <circle cx="40" cy="26" r="20" fill="var(--lens-fill)" stroke="var(--lens-stroke)" stroke-width="3.5"/>
                <circle cx="34" cy="19.5" r="5" fill="var(--lens-gloss)"/>
                <text x="40" y="26" text-anchor="middle" dominant-baseline="middle"
                      font-family="Microsoft JhengHei, PingFang HK, Noto Sans CJK, Arial"
                      font-size="24" font-weight="900" fill="#2f3b7c">ç†</text>
                <line x1="26" y1="36" x2="15" y2="47" stroke="var(--lens-stroke)" stroke-width="5" stroke-linecap="round"/>
              </svg>
            </div>
            <h1 class="main-title">è²¡ç­–åŠƒå°ˆæ¥­æœå‹™è·Ÿé€²</h1>
          </div>
          <p class="subtitle-title">è«‹é¸æ“‡æ‚¨é—œæ³¨çš„é …ç›®ï¼ˆé»æ“Šå¡ç‰‡å³å¯å‹¾é¸ï¼å–æ¶ˆï¼‰</p>
        </div>

        <!-- Cards -->
        <form id="checklist" class="grid">
          <!-- 1 -->
          <label class="card" data-id="emergency-cash">
            <input class="check" type="checkbox" name="emergency-cash" />
            <div class="icon"><span class="emoji">ğŸ’°</span></div>
            <div class="title">æ‡‰æ€¥ç¾é‡‘ï¼ˆå±ç–¾ï¼‰</div>
            <div class="subtitle">è¶³å¤ æä¾›ä¸€å¹´æ—¥å¸¸æ”¯å‡º</div>
            <div class="footer">å»ºç«‹ç·Šæ€¥å‚™ç”¨é‡‘ï¼Œæå‡æŠ—é¢¨éšªèƒ½åŠ›ï¼Œ æ¶µè“‹å®¶åº­æ¯æœˆå¿…è¦é–‹æ”¯</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 2 -->
          <label class="card" data-id="health-protection">
            <input class="check" type="checkbox" name="health-protection" />
            <div class="icon"><span class="emoji">ğŸ©º</span></div>
            <div class="title">é†«ç™‚åŠäººå£½ä¿éšœï¼ˆç™Œç—‡æ²»ç™‚ä¿éšœï¼‰</div>
            <div class="subtitle">æ‡‰ä»˜è¡æ“Šå¸¶ä¾†çš„é†«ç™‚åŠå®¶åº­è®Šæ•…</div>
            <div class="footer">é†«ç™‚ä¿éšªï¼‹å£½éšªé…ç½®ï¼Œå®ˆè­·å®¶åº­</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 3 -->
          <label class="card" data-id="premium-offset">
            <input class="check" type="checkbox" name="premium-offset" />
            <div class="icon"><span class="emoji">ğŸ“ˆ</span></div>
            <div class="title">ä¿è²»å°æ²–æ–¹æ¡ˆ</div>
            <div class="subtitle">æ‡‰ä»˜ä¿è²»èª¿æ•´åŠå¢åŠ </div>
            <div class="footer">è³‡ç”¢é…ç½®ä»¥å¹³æ»‘é•·æœŸä¿è²»å£“åŠ›</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 4 -->
          <label class="card" data-id="annuity-income">
            <input class="check" type="checkbox" name="annuity-income" />
            <div class="icon"><span class="emoji">ğŸ </span></div>
            <div class="title">å®šæœŸå¹´é‡‘æ”¶å…¥</div>
            <div class="subtitle">æä¾›ç©©å®šç”Ÿæ´»å…¥æ¯</div>
            <div class="footer">é€€ä¼‘ç¾é‡‘æµè¨ˆåŠƒèˆ‡é€šè„¹å°æ²–</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 5 -->
          <label class="card" data-id="legacy-planning">
            <input class="check" type="checkbox" name="legacy-planning" />
            <div class="icon"><span class="emoji">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span></div>
            <div class="title">æ„›çš„è³‡ç”¢å‚³æ‰¿</div>
            <div class="subtitle">è²¡å¯Œå¢å€¼å‚³æ‰¿è‡³ç¬¬äºŒä»£</div>
            <div class="footer">ä¿¡è¨—ï¼éºå›‘ï¼å£½éšªå‚³æ‰¿å®‰æ’</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 6 -->
          <label class="card" data-id="retirement-risk">
            <input class="check" type="checkbox" name="retirement-risk" />
            <div class="icon"><span class="emoji" style="font-size:26px; letter-spacing:-6px; line-height:1;">ğŸ‘µğŸ‘´</span></div>
            <div class="title">é€€ã€Œæ†‚ã€å®‰æ’</div>
            <div class="subtitle">æ‡‰ä»˜é•·å£½ç”Ÿæ´»é–‹æ”¯</div>
            <div class="footer">é•·å£½é¢¨éšªç®¡ç†èˆ‡é†«ç™‚è­·ç†æº–å‚™ï¼Œè§£æ±ºç”Ÿæ´»è²»ç”¨ï¼Œç„¡éœ€æˆç‚ºå­å¥³è² æ“”</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>
        </form>
      </div>
    </div>

    <!-- Buttons -->
    <div class="actions">
      <button class="btn" type="button" id="clearBtn">æ¸…é™¤é¸æ“‡</button>
      <button class="btn" type="button" id="pngBtn">å°å‡º PNG</button>
      <button class="btn primary" type="button" id="pdfBtn">å°å‡º PDF</button>
    </div>

    <p class="note">æç¤ºï¼šä½ çš„é¸æ“‡æœƒè‡ªå‹•å„²å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ä¸­ã€‚è«‹ç¢ºä¿ä¸‹æ¬¡ä½¿ç”¨å‰æ¸…é™¤é¸é …ã€‚</p>
  </div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  // Wait until DOM and external libraries are ready
  window.addEventListener('load', () => {
    const form = document.getElementById('checklist');
    const exportFrame = document.getElementById('exportFrame');
    const pngBtn = document.getElementById('pngBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const clearBtn = document.getElementById('clearBtn');

    const clientName = document.getElementById('clientName');
    const nameMirror = document.getElementById('nameMirror');

    // âœ… NEW: Age + Gender
    const clientAge = document.getElementById('clientAge');
    const ageMirror = document.getElementById('ageMirror');
    const clientGender = document.getElementById('clientGender');
    const genderMirror = document.getElementById('genderMirror');

    const todayDate = document.getElementById('todayDate');

    const KEY = 'fp_checklist_v1';
    const KEY_NAME = 'fp_client_name';

    // âœ… NEW keys
    const KEY_AGE = 'fp_client_age';
    const KEY_GENDER = 'fp_client_gender';

    const SCALE = 2;

    // Date
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    todayDate.textContent = `${yyyy}/${mm}/${dd}`;
    const yyyymmdd = `${yyyy}${mm}${dd}`;

    // ===== Name restore + mirror =====
    clientName.value = localStorage.getItem(KEY_NAME) || '';
    syncNameMirror();
    clientName.addEventListener('input', () => {
      localStorage.setItem(KEY_NAME, clientName.value);
      syncNameMirror();
    });
    function syncNameMirror(){
      const v = clientName.value.trim();
      if (v) { nameMirror.textContent = v; nameMirror.classList.remove('placeholder'); }
      else { nameMirror.textContent = 'ï¼ˆè«‹è¼¸å…¥å§“åï¼‰'; nameMirror.classList.add('placeholder'); }
    }

    // ===== âœ… Age restore + mirror =====
    clientAge.value = localStorage.getItem(KEY_AGE) || '';
    syncAgeMirror();
    clientAge.addEventListener('input', () => {
      // keep digits only + clamp 0-120 (soft clamp)
      const raw = String(clientAge.value || '').replace(/[^\d]/g, '');
      let num = raw === '' ? '' : Math.max(0, Math.min(120, parseInt(raw, 10)));
      clientAge.value = (num === '' ? '' : String(num));

      localStorage.setItem(KEY_AGE, clientAge.value);
      syncAgeMirror();
    });
    function syncAgeMirror(){
      const v = String(clientAge.value || '').trim();
      if (v) { ageMirror.textContent = v; ageMirror.classList.remove('placeholder'); }
      else { ageMirror.textContent = 'ï¼ˆâ€”ï¼‰'; ageMirror.classList.add('placeholder'); }
    }

    // ===== âœ… Gender restore + mirror =====
    const savedGender = localStorage.getItem(KEY_GENDER) || '';
    if (savedGender) {
      // try set value if exists in options
      clientGender.value = savedGender;
    }
    syncGenderMirror();
    clientGender.addEventListener('change', () => {
      localStorage.setItem(KEY_GENDER, clientGender.value || '');
      syncGenderMirror();
    });
    function syncGenderMirror(){
      const v = (clientGender.value || '').trim();
      if (v) { genderMirror.textContent = v; genderMirror.classList.remove('placeholder'); }
      else { genderMirror.textContent = 'ï¼ˆè«‹é¸æ“‡ï¼‰'; genderMirror.classList.add('placeholder'); }
    }

    // Library checks
    if (typeof window.html2canvas !== 'function') { alert('html2canvas è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– CDNã€‚'); return; }
    if (!window.jspdf || typeof window.jspdf.jsPDF !== 'function') { alert('jsPDF è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– CDNã€‚'); return; }

    // Restore quick checkbox state
    const saved = JSON.parse(localStorage.getItem(KEY) || '{}');
    [...form.querySelectorAll('.card')].forEach(card => {
      const id = card.dataset.id;
      const input = card.querySelector('.check');
      const isChecked = !!saved[id];
      input.checked = isChecked;
      card.classList.toggle('checked', isChecked);
      input.addEventListener('change', () => {
        card.classList.toggle('checked', input.checked);
        persist();
      });
    });
    function persist(){
      const state = {};
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const input = card.querySelector('.check');
        state[id] = input.checked;
      });
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    /* ============================
       Money + Currency + Deficit (ä¸è¶³ï¼)
       ============================ */
    const MONEY_INPUTS = new Map(); // id -> { input, box, toggle, currencySelect, deficitBtn, card }

    function setupMoneyAndDeficit(){
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const money = card.querySelector('.money');
        if(!money) return;

        const box = money.querySelector('.money-box');
        const toggleBtn = money.querySelector('.money-toggle');
        const input = money.querySelector('.money-input');
        const currencySelect = money.querySelector('.currency-select');
        const deficitBtn = money.querySelector('.deficit-toggle');

        if(!box || !toggleBtn || !input || !currencySelect || !deficitBtn) return;

        // Prevent label toggle while interacting
        const stopOnly = (e) => { e.stopPropagation(); };
        toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); box.classList.toggle('open'); });
        input.addEventListener('click', stopOnly);
        currencySelect.addEventListener('click', stopOnly);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } e.stopPropagation(); });

        // Sanitize input
        input.addEventListener('input', () => {
          const v = input.value.replace(/[^\d.]/g, '');
          const parts = v.split('.');
          input.value = parts.length > 2 ? (parts[0] + '.' + parts.slice(1).join('')) : v;
        });

        // ä¸è¶³ï¼ toggle
        deficitBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const next = deficitBtn.getAttribute('aria-pressed') !== 'true';
          deficitBtn.setAttribute('aria-pressed', String(next));
          card.classList.toggle('deficit', next);
        });

        MONEY_INPUTS.set(id, { input, box, toggle: toggleBtn, currencySelect, deficitBtn, card });
      });
    }
    setupMoneyAndDeficit();

    function readAmounts(){ const out = {}; MONEY_INPUTS.forEach((r, id)=> out[id]=(r.input.value||'').trim()); return out; }
    function readCurrencies(){ const out = {}; MONEY_INPUTS.forEach((r, id)=> out[id]=r.currencySelect.value || 'HKD'); return out; }
    function readDeficits(){ const out = {}; MONEY_INPUTS.forEach((r, id)=> out[id]=r.card.classList.contains('deficit')); return out; }

    function applyAmounts(amounts = {}){ MONEY_INPUTS.forEach((r,id)=>{ const v=amounts[id]||''; r.input.value=v; r.box.classList.toggle('open', !!v); }); }
    function applyCurrencies(currencies = {}){ MONEY_INPUTS.forEach((r,id)=>{ r.currencySelect.value = currencies[id] || 'HKD'; }); }
    function applyDeficits(deficits = {}){ MONEY_INPUTS.forEach((r,id)=>{ const on=!!deficits[id]; r.card.classList.toggle('deficit', on); r.deficitBtn.setAttribute('aria-pressed', String(on)); }); }

    // Clear: also clear name, age, gender, money, currency, deficit
    clearBtn.addEventListener('click', () => {
      [...form.querySelectorAll('.card')].forEach(card => {
        const input = card.querySelector('.check');
        input.checked = false;
        card.classList.remove('checked', 'deficit');
      });
      persist();

      clientName.value = '';
      localStorage.removeItem(KEY_NAME);
      syncNameMirror();

      // âœ… NEW clear age/gender
      clientAge.value = '';
      localStorage.removeItem(KEY_AGE);
      syncAgeMirror();

      clientGender.value = '';
      localStorage.removeItem(KEY_GENDER);
      syncGenderMirror();

      MONEY_INPUTS.forEach(({ input, box, currencySelect, deficitBtn }) => {
        input.value = '';
        box.classList.remove('open');
        currencySelect.value = 'HKD';
        deficitBtn.setAttribute('aria-pressed', 'false');
      });

      clientName.focus();
    });

    // Capture with export-only UI swap
    async function captureWithExporting(fn){
      exportFrame.classList.add('exporting');
      clientName.blur();
      clientAge.blur();
      clientGender.blur?.();
      try { await fn(); } finally { exportFrame.classList.remove('exporting'); }
    }
    function safeFilename(base){ return base.replace(/[\\/:*?"<>|]/g, '_').replace(/\s+/g, ' ').trim(); }

    // Export PNG
    pngBtn.addEventListener('click', () => {
      captureWithExporting(async () => {
        const canvas = await html2canvas(exportFrame, { backgroundColor: '#ffffff', scale: SCALE, useCORS: true, logging: false });
        canvas.toBlob((blob) => {
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const client = (clientName.value.trim() || 'é¸é …æˆªåœ–');
          a.href = url; a.download = `${safeFilename(client)}_${yyyymmdd}.png`; a.click();
          URL.revokeObjectURL(url);
        }, 'image/png');
      });
    });

    // Export PDF
    pdfBtn.addEventListener('click', () => {
      captureWithExporting(async () => {
        const canvas = await html2canvas(exportFrame, { backgroundColor: '#ffffff', scale: SCALE, useCORS: true, logging: false });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const isLandscape = canvas.width > canvas.height;
        const pdf = new jsPDF({ orientation: isLandscape ? 'landscape' : 'portrait', unit: 'pt', format: 'a4' });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const maxW = pageW * 0.90, maxH = pageH * 0.90;
        const ratio = Math.min(maxW / canvas.width, maxH / canvas.height);
        const imgW = canvas.width * ratio, imgH = canvas.height * ratio;
        const x = (pageW - imgW) / 2, y = (pageH - imgH) / 2;
        pdf.addImage(imgData, 'PNG', x, y, imgW, imgH);
        const client = (clientName.value.trim() || 'é¸é …æˆªåœ–');
        pdf.save(`${safeFilename(client)}_${yyyymmdd}.pdf`);
      });
    });

    /* === Sidebar (hidden by default) + Save Profiles === */

    // Inject sidebar CSS
    const __sidebarCSS = `
    .client-sidebar{
      position: fixed; inset: 0 auto 0 0; width: 260px;
      background:#fff; border-right:1px solid #e8eaf3;
      padding:16px 12px; overflow:auto;
      box-shadow:0 0 10px rgba(0,0,0,.06);
      transform:translateX(-100%); transition:transform .2s ease;
      z-index:9;
    }
    body.sidebar-open .client-sidebar{ transform:translateX(0); }
    .client-sidebar h2{ margin:4px 8px 8px; font-size:14px; letter-spacing:.5px; color:#1f2a3a; }
    .client-sidebar .search{ width:100%; padding:8px 10px; border:1px solid #cfd6e7; border-radius:8px; margin:8px 6px 12px; font-size:13px; }
    .client-list{ list-style:none; margin:0; padding:0 6px; display:grid; gap:8px; }
    .client-item{ border:1px solid #e0e3eb; border-radius:10px; padding:10px; background:#fff; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .client-item .meta{ display:flex; flex-direction:column; min-width:0; }
    .client-item .name{ font-weight:700; font-size:14px; color:#1f2a3a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .client-item .date{ font-size:12px; color:#5f6368; }
    .client-item .actions{ display:flex; gap:6px; }
    .client-item .btn-xs{ border:1px solid #cfd6e7; background:#fff; color:#1a2a3a; padding:4px 8px; border-radius:8px; font-size:12px; cursor:pointer; }
    .client-empty{ padding:10px 8px; color:#5f6368; font-size:12px; }
    .sidebar-toggle{
      position:fixed;
      left:max(10px, env(safe-area-inset-left,0px) + 10px);
      top:max(10px, env(safe-area-inset-top,0px) + 10px);
      z-index:10; border:1px solid #cfd6e7; background:#fff; padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
    }
    @media (max-width:480px){
      .sidebar-toggle{
        left:auto;
        right:max(10px, env(safe-area-inset-right,0px) + 10px);
        top:max(10px, env(safe-area-inset-top,0px) + 10px);
      }
      .client-sidebar{ width:85vw; }
    }`;
    const styleEl = document.createElement('style'); styleEl.textContent = __sidebarCSS; document.head.appendChild(styleEl);

    // Build sidebar
    const sidebar = document.createElement('aside');
    sidebar.className = 'client-sidebar';
    sidebar.setAttribute('aria-hidden', 'true');
    sidebar.innerHTML = `
      <h2>å®¢æˆ¶åˆ—è¡¨</h2>
      <input type="search" class="search" placeholder="æœå°‹å§“åâ€¦" aria-label="æœå°‹å§“å" />
      <ul class="client-list" id="clientList"></ul>
      <div class="client-empty" id="clientEmpty" style="display:none;">å°šæœªå„²å­˜ä»»ä½•å®¢æˆ¶ã€‚</div>`;
    document.body.appendChild(sidebar);

    // Toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'sidebar-toggle';
    toggleBtn.type = 'button';
    toggleBtn.setAttribute('aria-expanded', 'false');
    toggleBtn.setAttribute('aria-controls', 'clientList');
    toggleBtn.textContent = 'â˜° å®¢æˆ¶';
    toggleBtn.addEventListener('click', () => {
      const open = document.body.classList.toggle('sidebar-open');
      toggleBtn.setAttribute('aria-expanded', String(open));
      sidebar.setAttribute('aria-hidden', String(!open));
    });
    document.body.appendChild(toggleBtn);

    // Insert Save (2nd from left â€” before PNG)
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn';
    saveBtn.type = 'button';
    saveBtn.id = 'saveBtn';
    saveBtn.textContent = 'å„²å­˜è³‡æ–™';
    pngBtn.insertAdjacentElement('beforebegin', saveBtn);

    // Profiles storage
    const PROFILES_KEY = 'fp_profiles_v1';
    function loadProfiles(){ try{ return JSON.parse(localStorage.getItem(PROFILES_KEY)) || []; }catch(e){ return []; } }
    function storeProfiles(list){ localStorage.setItem(PROFILES_KEY, JSON.stringify(list)); }

    function readState(){
      const s = {};
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        s[id] = !!card.querySelector('.check').checked;
      });
      return s;
    }

    function applyState(state){
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const on = !!state[id];
        const input = card.querySelector('.check');
        input.checked = on; card.classList.toggle('checked', on);
      });
      persist();
    }

    function formatDT(d = new Date()){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mn=String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mn}`;
    }

    // Save profile (includes deficits + âœ… age/gender)
    function saveProfile(){
      const name = clientName.value.trim();
      if(!name){ alert('è«‹å…ˆè¼¸å…¥å®¢æˆ¶å§“åå†å„²å­˜ã€‚'); clientName.focus(); return; }

      const profiles = loadProfiles();
      const idx = profiles.findIndex(p => p.name === name);

      const profile = {
        id: idx >= 0 ? profiles[idx].id : `p_${Date.now()}`,
        name,
        age: (clientAge.value || '').trim(),
        gender: (clientGender.value || '').trim(),
        state: readState(),
        amounts: readAmounts(),
        currencies: readCurrencies(),
        deficits: readDeficits(),
        savedAt: formatDT()
      };

      if(idx >= 0) profiles[idx] = profile; else profiles.unshift(profile);
      storeProfiles(profiles);

      localStorage.setItem(KEY_NAME, name);
      localStorage.setItem(KEY_AGE, profile.age);
      localStorage.setItem(KEY_GENDER, profile.gender);

      renderClientList();
    }

    // Load / Delete
    function loadProfileById(id){
      const profiles = loadProfiles();
      const p = profiles.find(x => x.id === id);
      if(!p) return;

      clientName.value = p.name || '';
      localStorage.setItem(KEY_NAME, clientName.value);
      syncNameMirror();

      // âœ… NEW apply age/gender
      clientAge.value = (p.age || '');
      localStorage.setItem(KEY_AGE, clientAge.value);
      syncAgeMirror();

      clientGender.value = (p.gender || '');
      localStorage.setItem(KEY_GENDER, clientGender.value);
      syncGenderMirror();

      applyState(p.state || {});
      applyAmounts(p.amounts || {});
      applyCurrencies(p.currencies || {});
      applyDeficits(p.deficits || {});

      document.body.classList.remove('sidebar-open');
      toggleBtn.setAttribute('aria-expanded', 'false');
      sidebar.setAttribute('aria-hidden', 'true');
    }
    function deleteProfile(id){
      const profiles = loadProfiles().filter(p => p.id !== id);
      storeProfiles(profiles);
      renderClientList();
    }

    // Sidebar render
    function renderClientList(filterText = ''){
      const listEl = document.getElementById('clientList');
      const emptyEl = document.getElementById('clientEmpty');
      const profiles = loadProfiles();
      const q = filterText.trim().toLowerCase();
      const filtered = q ? profiles.filter(p => (p.name||'').toLowerCase().includes(q)) : profiles;

      listEl.innerHTML = '';
      emptyEl.style.display = filtered.length ? 'none' : 'block';

      filtered.forEach(p => {
        const li = document.createElement('li');
        li.className = 'client-item';
        li.innerHTML = `
          <div class="meta">
            <div class="name" title="${p.name}">${p.name}</div>
            <div class="date">ä¸Šæ¬¡å„²å­˜ï¼š${p.savedAt}</div>
          </div>
          <div class="actions">
            <button class="btn-xs load">è¼‰å…¥</button>
            <button class="btn-xs del" title="åˆªé™¤">åˆªé™¤</button>
          </div>`;
        li.querySelector('.load').addEventListener('click', () => loadProfileById(p.id));
        li.querySelector('.del').addEventListener('click', () => {
          if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${p.name}ã€çš„è³‡æ–™ï¼Ÿ`)){ deleteProfile(p.id); }
        });
        listEl.appendChild(li);
      });
    }

    saveBtn.addEventListener('click', saveProfile);
    sidebar.querySelector('.search').addEventListener('input', (e) => renderClientList(e.target.value));
    renderClientList();

    // Close sidebar before export & Esc
    const closeSidebar = () => {
      if (document.body.classList.contains('sidebar-open')) {
        document.body.classList.remove('sidebar-open');
        toggleBtn.setAttribute('aria-expanded', 'false');
        sidebar.setAttribute('aria-hidden', 'true');
      }
    };
    pngBtn.addEventListener('click', closeSidebar, true);
    pdfBtn.addEventListener('click', closeSidebar, true);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });
  });
</script>
</body>
</html>












