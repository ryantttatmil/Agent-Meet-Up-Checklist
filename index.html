
<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†è²¡ç­–åŠƒå°ˆæ¥­æœå‹™è·Ÿé€²</title>

<style>
  :root{
    --bg: #f6f7fb;
    --card: #ffffff;
    --ink: #202124;
    --muted: #5f6368;
    --brand: #1a73e8;
    --border: #e0e3eb;
    --checked: #e6f3ff;

    /* Deficit (ä¸è¶³ï¼) theme */
    --deficit-border: #d93025;
    --deficit-bg: #fde8e6;

    /* Magnifier colors */
    --lens-stroke: #2f3b7c;
    --lens-fill:   #ffffff;
    --lens-gloss:  #e3e9ff;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang HK", "Heiti TC", "Microsoft JhengHei", sans-serif;
    background: var(--bg);
    color: var(--ink);
    padding: 28px 18px 40px;
  }
  .wrap { max-width: 980px; margin: 0 auto; }

  /* Export frame */
  .export-frame {
    background: #fff;
    padding: 24px;
    border: 1px solid #e8eaf3;
    border-radius: 12px;
  }

  /* Top info bar (Name + Date) */
  .info-bar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
    margin-bottom: 10px;
  }
  .name-field {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    flex-wrap: wrap;
  }
  .name-field label { color: #1f2a3a; }

  /* Field pairs (label + input/select) stick together */
  .field-pair{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    flex: 0 0 auto;
    max-width: 100%;
    min-width: 0;
  }
  .field-pair > label{
    white-space: nowrap;
    flex: 0 0 auto;
    line-height: 1.2;
  }
  .name-input,
  .age-input,
  .gender-select,
  .name-mirror,
  .age-mirror,
  .gender-mirror{
    min-width: 0;
  }

  /* Toggle slot */
  .toggle-slot{
    display: inline-flex;
    align-items: center;
    flex: 0 0 auto;
  }

  /* Inputs (Name/Age/Gender share same base style) */
  .name-input,
  .age-input,
  .gender-select {
    padding: 8px 10px;
    border: 1px solid #cfd6e7;
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
  }

  .name-input { flex: 1 1 auto; max-width: 320px; }
  .age-input{ width: 96px; }
  .gender-select{ width: 150px; }

  /* Mirrors (export only) */
  .name-mirror,
  .age-mirror,
  .gender-mirror {
    display: none;
    min-height: 22px;
    padding: 0 2px;
    border-bottom: 1px dashed #cfd6e7;
    color: #1f2a3a;
    font-weight: 700;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .name-mirror { max-width: 320px; }
  .age-mirror  { min-width: 54px; }
  .gender-mirror { min-width: 72px; }

  .name-mirror.placeholder,
  .age-mirror.placeholder,
  .gender-mirror.placeholder { color: #9aa0a6; font-weight: 400; }

  .exporting .name-mirror,
  .exporting .age-mirror,
  .exporting .gender-mirror { display: inline-block !important; }

  .exporting .name-input,
  .exporting .age-input,
  .exporting .gender-select { display: none !important; }


  /* Hide from PNG/PDF exports */
  .exporting .no-export{ 
    display: none !important; 
  }

  @media print{
    .no-export{ display: none !important; }
  }


  /* Date field plain text style (not a box) */
  .date-field{
    font-size: 14px;
    color: #1f2a3a;
    font-weight: 700;
    padding: 0;
    border: none;
    border-radius: 0;
    background: transparent;
    box-shadow: none;
    min-width: 0;
    text-align: right;
    white-space: nowrap;
  }

  .info-right{
    display: inline-flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    white-space: nowrap;
  }

  /* Toggle button styling */
  .sidebar-toggle-inline{
    border: 1px solid #cfd6e7;
    background: #fff;
    color: #1a2a3a;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .sidebar-toggle-inline:hover{
    border-color: #c6d2f7;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
  }

  /* ===== Header / Title ===== */
  .title-box {
    background: linear-gradient(135deg, #ffe9f0, #e8f0fe);
    border: 1px solid #d7deed;
    border-radius: 14px;
    padding: 18px 20px;
    margin-bottom: 22px;

    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    text-align: center;
  }

  .title-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .title-icon { width: 68px; height: 68px; margin-top: 12px; flex: 0 0 auto; }
  .title-icon svg { display: block; width: 68px; height: 68px; }

  .main-title {
    margin: 0;
    font-size: 24px;
    font-weight: 900;
    line-height: 1.2;
    word-break: keep-all;
    transform: translateY(-2px);
  }
  @media (max-width: 480px) {
    .main-title { transform: translateY(-1px); }
  }

  .subtitle-title { margin: 0; color: var(--muted); font-size: 14px; }

  /* ===== Grid (CLEAN, CONSISTENT) ===== */
  .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }

  /* Tablet: 2 cols */
  @media (min-width: 481px) and (max-width: 1024px){
    .grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* Mobile portrait: 1 col */
  @media (max-width: 480px) and (orientation: portrait){
    .grid { grid-template-columns: 1fr; gap: 22px; }
  }

  /* Mobile landscape fix: use max-height (landscape width is usually > 480) */
  @media (max-height: 480px) and (orientation: landscape){
    .grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
  }

  /* Card */
  .card {
    position: relative;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    min-height: 150px;

    display: grid;
    grid-template-columns: 68px minmax(0, 1fr);
    grid-template-rows: auto auto 1fr;
    grid-template-areas: "icon title" "icon subtitle" "icon footer";
    column-gap: 12px;
    cursor: pointer;
    transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;

    max-width: 100%;
    overflow: hidden;
  }
  .card:hover { border-color: #c6d2f7; box-shadow: 0 4px 14px rgba(0,0,0,.06); }
  .card.checked { border-color: var(--brand); background: var(--checked); box-shadow: 0 6px 16px rgba(26,115,232,.12); }

  /* ğŸ”´ Deficit (ä¸è¶³ï¼) state */
  .card.deficit {
    border-color: var(--deficit-border) !important;
    background: var(--deficit-bg) !important;
    box-shadow: 0 6px 16px rgba(217,48,37,.12);
  }

  .check { position: absolute; inset: 0; opacity: 0; pointer-events: none; }

  .icon {
    grid-area: icon;
    width: 68px; height: 68px;
    border: 1px solid var(--border);
    border-radius: 10px;
    display: grid; place-items: center; overflow: hidden; background: #fafbff;
    min-width: 0;
  }
  .emoji { font-size: 36px; line-height: 1; }

  .title { grid-area: title; font-weight: 800; color: #1f3b2d; font-size: 16px; line-height: 1.25; margin-top: 2px; min-width: 0; }
  .subtitle { grid-area: subtitle; color: #2a6f37; font-weight: 600; font-size: 13px; margin-top: 6px; min-width: 0; }
  .footer { grid-area: footer; margin-top: 10px; color: var(--muted); font-size: 12px; min-width: 0; }

  .tick {
    position: absolute; top: 10px; right: 10px;
    display: inline-flex; align-items: center; gap: 6px;
    background: #e8f5e9; color: #0c6b2e; border: 1px solid #bfe8c9;
    border-radius: 999px; padding: 4px 8px; font-size: 12px;
    opacity: 0; transform: translateY(-4px); transition: all .18s ease;
  }
  .card.checked .tick { opacity: 1; transform: translateY(0); }

  /* Prevent âœ“ badge from covering text */
  .card .title,
  .card .subtitle,
  .card .footer{
    padding-right: 78px;
    box-sizing: border-box;
  }

  .note { margin-top: 14px; color: var(--muted); font-size: 12px; text-align: center; }
  .actions { display: flex; gap: 10px; justify-content: center; margin-top: 18px; flex-wrap: wrap; }
  .btn { border: 1px solid #cfd6e7; background: #fff; color: #1a2a3a; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
  .btn.primary { background: var(--brand); border-color: var(--brand); color: #fff; }

  @media print { .actions, .note { display: none !important; } body { background: #fff; padding: 0; } }


  /* ===== Useful Links (å¯¦ç”¨é€£çµ) ===== */
  .useful-links{
    margin-top: 18px;
    padding: 14px 14px 12px;
    background: #ffffff;
    border: 1px solid #e8eaf3;
    border-radius: 12px;
  }

  .useful-links__title{
    margin: 0 0 10px;
    font-size: 14px;
    font-weight: 800;
    color: #1f2a3a;
    letter-spacing: .2px;
  }

  .useful-links__list{
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .useful-links__item{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    border: 1px solid #cfd6e7;
    border-radius: 10px;
    background: #fff;
    text-decoration: none;
    color: #1a73e8;
    font-weight: 700;
    font-size: 13px;
    line-height: 1;
    max-width: 100%;
  }

  .useful-links__item:hover{
    border-color: #c6d2f7;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
  }

  .useful-links__hint{
    margin: 10px 0 0;
    font-size: 12px;
    color: #5f6368;
  }



  /* ===== Money area ===== */
  .money { grid-column: 1 / -1; margin-top: 8px; width: 100%; min-width: 0; }

  /* Row above the input: left = é‡‘é¡ toggle, right = ä¸è¶³ï¼ toggle */
  .money .money-header {
    display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%; min-width: 0;
  }

  .money .money-toggle,
  .money .deficit-toggle {
    border: 1px solid #cfd6e7;
    background: #fff;
    color: #1a2a3a;
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 12px;
    cursor: pointer;
    flex: 0 0 auto;
  }
  .money .deficit-toggle[aria-pressed="true"] {
    background: var(--deficit-border);
    border-color: var(--deficit-border);
    color: #fff;
  }

  .money .money-box { display: none; margin-top: 8px; width: 100%; max-width: 100%; overflow: hidden; }
  .money .money-box.open { display: block; }

  .money .money-field {
    display: flex; align-items: center; gap: 8px;
    border: 1px solid #cfd6e7; border-radius: 8px; padding: 6px 8px; background: #fff;
    width: 100%; max-width: 100%; min-width: 0;
  }
  .money .currency-select {
    border: 1px solid #cfd6e7; border-radius: 6px; padding: 4px 8px; font-size: 12px; background: #fff; color: #1a2a3a;
    flex: 0 0 auto; max-width: 30%;
  }
  .money .money-input { flex: 1 1 auto; min-width: 0; width: 100%; border: 0; outline: none; font-size: 14px; }

  .money, .money * { pointer-events: auto; }

  /* Containment guards */
  .wrap, .export-frame, .grid { max-width: 100%; overflow-x: hidden; }

  /* Small card tweak */
  @media (max-width: 480px) and (orientation: portrait) {
    body { padding: 16px 12px 28px; }
    .export-frame { padding: 16px; border-radius: 10px; }

    .info-bar{ grid-template-columns: 1fr auto; align-items: start; gap: 10px; }
    .date-field{ justify-self: end; text-align: right; min-width: 0; padding: 0; font-size: 13px; }

    .sidebar-toggle-inline{ padding: 7px 10px; font-size: 13px; }

    .name-field{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 10px;
      align-items: start;
      width: 100%;
    }
    .name-field .toggle-slot{ grid-column: 1 / -1; }
    .name-field .field-pair:first-of-type{ grid-column: 1 / -1; }

    .field-pair{
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: 100%;
    }
    .field-pair > label{ font-size: 13px; }

    .name-input,
    .age-input,
    .gender-select{
      width: 100%;
      max-width: 100%;
      font-size: 13px;
      padding: 6px 10px;
      height: 36px;
      border-radius: 8px;
    }

    .title-box { gap: 8px; padding: 14px 12px; }
    .title-icon { width: 54px; height: 54px; margin-top: 12px; }
    .title-icon svg { width: 54px; height: 54px; }
    .main-title { font-size: 20px; line-height: 1.25; }
    .subtitle-title { font-size: 13px; }

    .card { grid-template-columns: 56px minmax(0, 1fr); padding: 12px; min-height: 140px; }
    .icon { width: 56px; height: 56px; }
    .icon .emoji { font-size: 24px; }

    [data-id="retirement-risk"] .icon .emoji { font-size: 22px !important; letter-spacing: -6px; line-height: 1; }
  }


  /* Calculator button (only appears on retirement-risk card) */
  .calc-btn{
    border: 1px solid #cfd6e7;
    background: #fff;
    color: #1a2a3a;
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
  }

  .calc-btn:hover{
    border-color: #c6d2f7;
    box-shadow: 0 2px 10px rgba(0,0,0,.06);
  }


  /* === Tablet "awkward ratio" fix: move text under icon (ONLY this range) ===
     Targets widths like ~500â€“820 and shorter height (split view / small tablet landscape).
     Does NOT affect mobile portrait (<=480) or desktop (>=1025). */
  
  /* === Awkward ratio fix: move text under icon === */
  /* Trigger purely by width (more reliable than max-height). */
  @media (min-width: 481px) and (max-width: 820px) {
    .card{
      grid-template-columns: 1fr;
      grid-template-rows: auto auto auto 1fr auto;
      grid-template-areas:
        "icon"
        "title"
        "subtitle"
        "footer"
        "money";
      row-gap: 8px;
    }

    /* Optional: center the icon (looks cleaner when stacked) */
    .card .icon{
      justify-self: start;   /* or center */
      /* justify-self: center; */
    }

    /* Remove reserved padding for âœ“ badge so text can use full width */
    .card .title,
    .card .subtitle,
    .card .footer{
      padding-right: 0;
    }

    /* Keep âœ“ badge at top-right */
    .card .tick{
      top: 10px;
      right: 10px;
    }

    /* Ensure money section stays in the final row */
    .card .money{
      grid-column: 1 / -1;
    }
  }

.currency-mirror{
      display: none;
      font-size: 12px;
      font-weight: 700;
      color: #1a2a3a;
      padding: 4px 8px;
      border: 1px solid #cfd6e7;
      border-radius: 6px;
      background: #fff;
      line-height: 1.4; /* âœ… no baseline clipping */
    }

    .exporting .currency-select{ display: none !important; }
    .exporting .currency-mirror{ display: inline-block !important; 
}

  /* Mobile landscape FIX: use max-height so it actually applies */
  @media (max-height: 480px) and (orientation: landscape){
    body { padding: 14px 12px 22px; }
    .export-frame { padding: 16px; border-radius: 10px; }
    .info-bar{ grid-template-columns: 1fr auto; align-items: start; gap: 10px; }
    .date-field{ justify-self: end; text-align: right; min-width: 0; padding: 0; font-size: 13px; }
    .sidebar-toggle-inline{ padding: 7px 10px; font-size: 13px; }

    .name-field{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 10px;
      align-items: start;
      width: 100%;
    }
    .name-field .toggle-slot{ grid-column: 1 / -1; }
    .name-field .field-pair:first-of-type{ grid-column: 1 / -1; }

    .field-pair{
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
      width: 100%;
    }
    .field-pair > label{ font-size: 13px; }

    .name-input,
    .age-input,
    .gender-select{
      width: 100%;
      max-width: 100%;
      font-size: 13px;
      padding: 6px 10px;
      height: 36px;
      border-radius: 8px;
    }

    /* âœ… Export: prevent bottom clipping (html2canvas sometimes trims last pixels) */
    .exporting #captureArea{
      padding-bottom: 18px; /* safe space for money input baseline */
    }

    /* Optional: ensure no cropping by overflow during export */
    .exporting .export-frame,
    .exporting .card,
    .exporting .grid{
      overflow: visible !important;
    }
  }
</style>
</head>

<body>
  <div class="wrap">

    <div class="export-frame" id="exportFrame">
      <div id="captureArea">
        <!-- Name + Date bar -->
        <div class="info-bar">
          <div class="name-field">
            <!-- Toggle slot -->
            <div class="toggle-slot"></div>

            <!-- Pair 1: Name -->
            <div class="field-pair">
              <label for="clientName">å®¢æˆ¶å§“åï¼š</label>
              <span id="nameMirror" class="name-mirror placeholder">ï¼ˆè«‹è¼¸å…¥å§“åï¼‰</span>
              <input id="clientName" class="name-input" type="text" placeholder="è«‹è¼¸å…¥å§“å" />
            </div>

            <!-- Pair 2: Age -->
            <div class="field-pair">
              <label for="clientAge">å¹´é½¡ï¼š</label>
              <span id="ageMirror" class="age-mirror placeholder">ï¼ˆâ€”ï¼‰</span>
              <input id="clientAge" class="age-input" type="number" min="0" max="1000" inputmode="numeric" placeholder="ä¾‹ï¼š35" />
            </div>

            <!-- Pair 3: Gender -->
            <div class="field-pair">
              <label for="clientGender">æ€§åˆ¥ï¼š</label>
              <span id="genderMirror" class="gender-mirror placeholder">ï¼ˆè«‹é¸æ“‡ï¼‰</span>
              <select id="clientGender" class="gender-select">
                <option value="" selected disabled>è«‹é¸æ“‡</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
                <option value="ä¸é¡˜é€éœ²">ä¸é¡˜é€éœ²</option>
              </select>
            </div>
          </div>

          <!-- Right side: Date -->
          <div class="info-right">
            <div id="todayDate" class="date-field">â€”</div>
          </div>
        </div>

        <!-- Title -->
        <div class="title-box">
          <div class="title-group">
            <div class="title-icon" aria-hidden="true">
              <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                <circle cx="40" cy="26" r="20" fill="var(--lens-fill)" stroke="var(--lens-stroke)" stroke-width="3.5"/>
                <circle cx="34" cy="19.5" r="5" fill="var(--lens-gloss)"/>
                <text x="40" y="26" text-anchor="middle" dominant-baseline="middle"
                      font-family="Microsoft JhengHei, PingFang HK, Noto Sans CJK, Arial"
                      font-size="24" font-weight="900" fill="#2f3b7c">ç†</text>
                <line x1="26" y1="36" x2="15" y2="47" stroke="var(--lens-stroke)" stroke-width="5" stroke-linecap="round"/>
              </svg>
            </div>
            <h1 class="main-title">è²¡ç­–åŠƒå°ˆæ¥­æœå‹™è·Ÿé€²</h1>
          </div>
          <p class="subtitle-title">è«‹é¸æ“‡æ‚¨é—œæ³¨çš„é …ç›®ï¼ˆé»æ“Šå¡ç‰‡å³å¯å‹¾é¸ï¼å–æ¶ˆï¼‰</p>
        </div>

        <!-- Cards -->
        <form id="checklist" class="grid">
          <!-- 1 -->
          <label class="card" data-id="emergency-cash">
            <input class="check" type="checkbox" name="emergency-cash" />
            <div class="icon"><span class="emoji">ğŸ’°</span></div>
            <div class="title">æ‡‰æ€¥ç¾é‡‘ï¼ˆå±ç–¾ï¼‰</div>
            <div class="subtitle">è¶³å¤ æä¾›ä¸€å¹´æ—¥å¸¸æ”¯å‡º</div>
            <div class="footer">å»ºç«‹ç·Šæ€¥å‚™ç”¨é‡‘ï¼Œæå‡æŠ—é¢¨éšªèƒ½åŠ›ï¼Œ æ¶µè“‹å®¶åº­æ¯æœˆå¿…è¦é–‹æ”¯</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 2 -->
          <label class="card" data-id="health-protection">
            <input class="check" type="checkbox" name="health-protection" />
            <div class="icon"><span class="emoji">ğŸ©º</span></div>
            <div class="title">é†«ç™‚åŠäººå£½ä¿éšœï¼ˆç™Œç—‡æ²»ç™‚ä¿éšœï¼‰</div>
            <div class="subtitle">æ‡‰ä»˜è¡æ“Šå¸¶ä¾†çš„é†«ç™‚åŠå®¶åº­è®Šæ•…</div>
            <div class="footer">é†«ç™‚ä¿éšªï¼‹å£½éšªé…ç½®ï¼Œå®ˆè­·å®¶åº­</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
		  <select class="currency-select" aria-label="è²¨å¹£">
  		    <option value="HKD">HKD$</option>
  		    <option value="USD">USD$</option>
		  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 3 -->
          <label class="card" data-id="premium-offset">
            <input class="check" type="checkbox" name="premium-offset" />
            <div class="icon"><span class="emoji">ğŸ“ˆ</span></div>
            <div class="title">ä¿è²»å°æ²–æ–¹æ¡ˆ</div>
            <div class="subtitle">æ‡‰ä»˜ä¿è²»èª¿æ•´åŠå¢åŠ </div>
            <div class="footer">è³‡ç”¢é…ç½®ä»¥å¹³æ»‘é•·æœŸä¿è²»å£“åŠ›</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 4 -->
          <label class="card" data-id="annuity-income">
            <input class="check" type="checkbox" name="annuity-income" />
            <div class="icon"><span class="emoji">ğŸ </span></div>
            <div class="title">å®šæœŸå¹´é‡‘æ”¶å…¥</div>
            <div class="subtitle">æä¾›ç©©å®šç”Ÿæ´»å…¥æ¯</div>
            <div class="footer">é€€ä¼‘ç¾é‡‘æµè¨ˆåŠƒèˆ‡é€šè„¹å°æ²–</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 5 -->
          <label class="card" data-id="legacy-planning">
            <input class="check" type="checkbox" name="legacy-planning" />
            <div class="icon"><span class="emoji">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span></div>
            <div class="title">æ„›çš„è³‡ç”¢å‚³æ‰¿</div>
            <div class="subtitle">è²¡å¯Œå¢å€¼å‚³æ‰¿è‡³ç¬¬äºŒä»£</div>
            <div class="footer">ä¿¡è¨—ï¼éºå›‘ï¼å£½éšªå‚³æ‰¿å®‰æ’</div>

            <div class="money">
              <div class="money-header">
                <button type="button" class="money-toggle">é‡‘é¡</button>
                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>

          <!-- 6 -->
          <label class="card" data-id="retirement-risk">
            <input class="check" type="checkbox" name="retirement-risk" />
            <div class="icon"><span class="emoji" style="font-size:26px; letter-spacing:-6px; line-height:1;">ğŸ‘µğŸ‘´</span></div>
            <div class="title">é€€ã€Œæ†‚ã€å®‰æ’</div>
            <div class="subtitle">æ‡‰ä»˜é•·å£½ç”Ÿæ´»é–‹æ”¯</div>
            <div class="footer">é•·å£½é¢¨éšªç®¡ç†èˆ‡é†«ç™‚è­·ç†æº–å‚™ï¼Œè§£æ±ºç”Ÿæ´»è²»ç”¨ï¼Œç„¡éœ€æˆç‚ºå­å¥³è² æ“”</div>

            <div class="money">
              <div class="money-header">
                <div style="display:flex; gap:8px; align-items:center;">
                  <button type="button" class="money-toggle">é‡‘é¡</button>
                  <button
                    type="button"
                    class="calc-btn"
                    aria-label="é€€ä¼‘è¨ˆç®—æ©Ÿ"
                    data-url="https://www.manulife.com.hk/zh-hk/individual/services/useful-calculators/retirement-calculator.html"
                  >
                    è¨ˆç®—æ©Ÿ
                  </button>
                </div>

                <button type="button" class="deficit-toggle" aria-pressed="false">ä¸è¶³ï¼</button>
              </div>
              <div class="money-box">
                <div class="money-field">
                  <select class="currency-select" aria-label="è²¨å¹£">
                    <option value="HKD">HKD$</option>
                    <option value="USD">USD$</option>
                  </select>
                  <input type="text" class="money-input" placeholder="è¼¸å…¥é‡‘é¡" inputmode="decimal" autocomplete="off" />
                </div>
              </div>
            </div>

            <div class="tick">âœ“ å·²é¸</div>
          </label>
        </form>
      </div>
    </div>

    <!-- Buttons -->
    <div class="actions">
      <button class="btn" type="button" id="clearBtn">æ¸…é™¤é¸æ“‡</button>
      <button class="btn" type="button" id="pngBtn">å°å‡º PNG</button>
      <button class="btn primary" type="button" id="pdfBtn">å°å‡º PDF</button>
    </div>

    <p class="note">æç¤ºï¼šä½ çš„é¸æ“‡æœƒè‡ªå‹•å„²å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ä¸­ã€‚è«‹ç¢ºä¿ä¸‹æ¬¡ä½¿ç”¨å‰æ¸…é™¤é¸é …ã€‚</p>

    <!-- Useful Links (NOT exported) -->
    <section class="useful-links no-export" aria-label="å¯¦ç”¨é€£çµ">
      <h2 class="useful-links__title">å¯¦ç”¨é€£çµ</h2>

      <div class="useful-links__list">
        <!-- Replace these with your own links -->
        <a class="useful-links__item" href="https://www.manulife.com.hk/zh-hk/individual.html" target="_blank" rel="noopener noreferrer">
          ğŸŒ å®˜æ–¹ç¶²ç«™
        </a>

        <a class="useful-links__item" href="https://www.manulife.com.hk/zh-hk/individual/products.html?cid=HK-EN_ML_IS_PS_BING_2024HKAlwaysOn_BRAND_BR_RSA_GenericBranding_CoreNew-EN-Exact_B2C_AQCTR_627184629_manulife%20hk&utm_source=BING&utm_medium=PS&utm_campaign=627184629_2024HKAlwaysOn&utm_content=B2C_manulife%20hk&utm_term=ML_IS_HK-EN_BRAND_BR_RSA_GenericBranding_CoreNew-EN-Exact_AQCTR&gclid=c68148634cdf13b94c01208da64ce703&gclsrc=3p.ds&msclkid=c68148634cdf13b94c01208da64ce703" target="_blank" rel="noopener noreferrer">
          ğŸ“˜ ç”¢å“/æœå‹™ä»‹ç´¹
        </a>

        <a class="useful-links__item" href="https://www.manulife.com.hk/zh-hk/individual/services/useful-calculators.html" target="_blank" rel="noopener noreferrer">
          ğŸ§® å¸¸ç”¨è¨ˆç®—æ©Ÿ
        </a>
      </div>

      <p class="useful-links__hint">ï¼Šä»¥ä¸Šé€£çµæœƒæ–¼æ–°åˆ†é é–‹å•Ÿ</p>
    </section>
  </div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  window.addEventListener('load', () => {
    const form = document.getElementById('checklist');
    const exportFrame = document.getElementById('exportFrame');
    const pngBtn = document.getElementById('pngBtn');
    const pdfBtn = document.getElementById('pdfBtn');
    const clearBtn = document.getElementById('clearBtn');

    const clientName = document.getElementById('clientName');
    const nameMirror = document.getElementById('nameMirror');

    const clientAge = document.getElementById('clientAge');
    const ageMirror = document.getElementById('ageMirror');
    const clientGender = document.getElementById('clientGender');
    const genderMirror = document.getElementById('genderMirror');

    const todayDate = document.getElementById('todayDate');

    const KEY = 'fp_checklist_v1';
    const KEY_NAME = 'fp_client_name';
    const KEY_AGE = 'fp_client_age';
    const KEY_GENDER = 'fp_client_gender';

    // âœ… NEW: Auto-save money/currency/deficit
    const KEY_AMOUNTS = 'fp_amounts_v1';
    const KEY_CURRENCIES = 'fp_currencies_v1';
    const KEY_DEFICITS = 'fp_deficits_v1';

    const SCALE = 2;

    // Date
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    todayDate.textContent = `${yyyy}/${mm}/${dd}`;
    const yyyymmdd = `${yyyy}${mm}${dd}`;

    // ===== Name restore + mirror =====
    clientName.value = localStorage.getItem(KEY_NAME) || '';
    syncNameMirror();
    clientName.addEventListener('input', () => {
      localStorage.setItem(KEY_NAME, clientName.value);
      syncNameMirror();
    });
    function syncNameMirror(){
      const v = clientName.value.trim();
      if (v) { nameMirror.textContent = v; nameMirror.classList.remove('placeholder'); }
      else { nameMirror.textContent = 'ï¼ˆè«‹è¼¸å…¥å§“åï¼‰'; nameMirror.classList.add('placeholder'); }
    }

    // ===== Age restore + mirror =====
    clientAge.value = localStorage.getItem(KEY_AGE) || '';
    syncAgeMirror();
    clientAge.addEventListener('input', () => {
      const raw = String(clientAge.value || '').replace(/[^\d]/g, '');
      let num = raw === '' ? '' : Math.max(0, Math.min(120, parseInt(raw, 10)));
      clientAge.value = (num === '' ? '' : String(num));
      localStorage.setItem(KEY_AGE, clientAge.value);
      syncAgeMirror();
    });
    function syncAgeMirror(){
      const v = String(clientAge.value || '').trim();
      if (v) { ageMirror.textContent = v; ageMirror.classList.remove('placeholder'); }
      else { ageMirror.textContent = 'ï¼ˆâ€”ï¼‰'; ageMirror.classList.add('placeholder'); }
    }

    // ===== Gender restore + mirror =====
    const savedGender = localStorage.getItem(KEY_GENDER) || '';
    if (savedGender) clientGender.value = savedGender;
    syncGenderMirror();
    clientGender.addEventListener('change', () => {
      localStorage.setItem(KEY_GENDER, clientGender.value || '');
      syncGenderMirror();
    });
    function syncGenderMirror(){
      const v = (clientGender.value || '').trim();
      if (v) { genderMirror.textContent = v; genderMirror.classList.remove('placeholder'); }
      else { genderMirror.textContent = 'ï¼ˆè«‹é¸æ“‡ï¼‰'; genderMirror.classList.add('placeholder'); }
    }

    // Library checks
    if (typeof window.html2canvas !== 'function') { alert('html2canvas è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– CDNã€‚'); return; }
    if (!window.jspdf || typeof window.jspdf.jsPDF !== 'function') { alert('jsPDF è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– CDNã€‚'); return; }

    // Restore checkbox state
    const saved = JSON.parse(localStorage.getItem(KEY) || '{}');
    [...form.querySelectorAll('.card')].forEach(card => {
      const id = card.dataset.id;
      const input = card.querySelector('.check');
      const isChecked = !!saved[id];
      input.checked = isChecked;
      card.classList.toggle('checked', isChecked);
      input.addEventListener('change', () => {
        card.classList.toggle('checked', input.checked);
        persistChecks();
      });
    });
    function persistChecks(){
      const state = {};
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const input = card.querySelector('.check');
        state[id] = input.checked;
      });
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    /* ============================
       Money + Currency + Deficit
       + âœ… Auto-save on change
       ============================ */
    
const MONEY_INPUTS = new Map(); // id -> record

function setupMoneyAndDeficit() {
  [...form.querySelectorAll('.card')].forEach(card => {
    const id = card.dataset.id;
    const money = card.querySelector('.money');
    if (!money) return;

    const box = money.querySelector('.money-box');
    const toggleBtn = money.querySelector('.money-toggle');
    const input = money.querySelector('.money-input');
    const currencySelect = money.querySelector('.currency-select');
    const deficitBtn = money.querySelector('.deficit-toggle');


    // âœ… Retirement card only: calculator redirect button
    const calcBtn = money.querySelector('.calc-btn');
    if (calcBtn) {
      calcBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const url = calcBtn.dataset.url;
        if (url) window.open(url, '_blank', 'noopener,noreferrer'); // open new tab
      });
    }


    if (!box || !toggleBtn || !input || !currencySelect || !deficitBtn) return;

    // Create currency mirror (export-only)
    let currencyMirror = money.querySelector('.currency-mirror');
    if (!currencyMirror) {
      currencyMirror = document.createElement('span');
      currencyMirror.className = 'currency-mirror';
      currencySelect.insertAdjacentElement('beforebegin', currencyMirror);
    }

    function syncCurrencyMirror() {
      const v = currencySelect.value || 'HKD';
      currencyMirror.textContent = (v === 'USD') ? 'USD$' : 'HKD$';
    }
    syncCurrencyMirror();

    const stopOnly = (e) => e.stopPropagation();

    // Money toggle (open/close)
    toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      box.classList.toggle('open');
    });

    // Prevent label click from toggling checkbox when using money controls
    input.addEventListener('click', stopOnly);
    currencySelect.addEventListener('click', stopOnly);
    deficitBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      const next = deficitBtn.getAttribute('aria-pressed') !== 'true';
      deficitBtn.setAttribute('aria-pressed', String(next));
      card.classList.toggle('deficit', next);

      persistDeficits();
    });

    // Amount input sanitize + auto-save
    input.addEventListener('input', () => {
      const v = input.value.replace(/[^\d.]/g, '');
      const parts = v.split('.');
      input.value = (parts.length > 2)
        ? (parts[0] + '.' + parts.slice(1).join(''))
        : v;

      persistAmounts();
    });

    // Currency change + auto-save
    currencySelect.addEventListener('change', (e) => {
      e.stopPropagation();
      syncCurrencyMirror();
      persistCurrencies();
    });

    MONEY_INPUTS.set(id, {
      input,
      box,
      currencySelect,
      currencyMirror,
      syncCurrencyMirror,
      deficitBtn,
      card
    });
  });
}

// âœ… IMPORTANT: call it AFTER the function is fully defined
setupMoneyAndDeficit();


    function readAmounts(){ const out = {}; MONEY_INPUTS.forEach((r, id)=> out[id]=(r.input.value||'').trim()); return out; }
    function readCurrencies(){ const out = {}; MONEY_INPUTS.forEach((r, id)=> out[id]=r.currencySelect.value || 'HKD'); return out; }
    function readDeficits(){ const out = {}; MONEY_INPUTS.forEach((r, id)=> out[id]=r.card.classList.contains('deficit')); return out; }

    function applyAmounts(amounts = {}){ MONEY_INPUTS.forEach((r,id)=>{ const v=amounts[id]||''; r.input.value=v; r.box.classList.toggle('open', !!v); }); }
    function applyCurrencies(currencies = {}){ 
      MONEY_INPUTS.forEach((r, id) => {
          r.currencySelect.value = currencies[id] || 'HKD';
          r.syncCurrencyMirror?.(); // âœ… update mirror after programmatic set
      });
    }
    function applyDeficits(deficits = {}){ MONEY_INPUTS.forEach((r,id)=>{ const on=!!deficits[id]; r.card.classList.toggle('deficit', on); r.deficitBtn.setAttribute('aria-pressed', String(on)); }); }

    // âœ… NEW: persist functions
    function persistAmounts(){ localStorage.setItem(KEY_AMOUNTS, JSON.stringify(readAmounts())); }
    function persistCurrencies(){ localStorage.setItem(KEY_CURRENCIES, JSON.stringify(readCurrencies())); }
    function persistDeficits(){ localStorage.setItem(KEY_DEFICITS, JSON.stringify(readDeficits())); }

    // âœ… NEW: restore on load (auto-save set 2)
    applyAmounts(JSON.parse(localStorage.getItem(KEY_AMOUNTS) || '{}'));
    applyCurrencies(JSON.parse(localStorage.getItem(KEY_CURRENCIES) || '{}'));
    applyDeficits(JSON.parse(localStorage.getItem(KEY_DEFICITS) || '{}'));

    // Clear: also clear name, age, gender, money, currency, deficit (and their keys)
    clearBtn.addEventListener('click', () => {
      [...form.querySelectorAll('.card')].forEach(card => {
        const input = card.querySelector('.check');
        input.checked = false;
        card.classList.remove('checked', 'deficit');
      });
      persistChecks();

      clientName.value = '';
      localStorage.removeItem(KEY_NAME);
      syncNameMirror();

      clientAge.value = '';
      localStorage.removeItem(KEY_AGE);
      syncAgeMirror();

      clientGender.value = '';
      localStorage.removeItem(KEY_GENDER);
      syncGenderMirror();

      
      MONEY_INPUTS.forEach((r) => {
        r.input.value = '';
        r.box.classList.remove('open');

        r.currencySelect.value = 'HKD';
        r.syncCurrencyMirror?.();   // âœ… correct

        r.deficitBtn.setAttribute('aria-pressed', 'false');
        r.card.classList.remove('deficit'); // âœ… also clear UI state
      });


      // âœ… remove auto-save keys
      localStorage.removeItem(KEY_AMOUNTS);
      localStorage.removeItem(KEY_CURRENCIES);
      localStorage.removeItem(KEY_DEFICITS);

      clientName.focus();
    });

    // Capture with export-only UI swap
    async function captureWithExporting(fn){
      // âœ… close sidebar before exporting, but only if closeSidebar exists
      try { closeSidebar?.(); } catch(e) {}

      exportFrame.classList.add('exporting');


      // âœ… force-sync mirrors right before capture
      MONEY_INPUTS.forEach((r) => r.syncCurrencyMirror?.());

      clientName.blur();
      clientAge.blur();
      clientGender.blur?.();

      // âœ… Export improvement (3):
      // Temporarily open money boxes where amount OR deficit exists
      const prevOpen = {};
      MONEY_INPUTS.forEach((r, id) => {
        prevOpen[id] = r.box.classList.contains('open');
        const hasAmount = (r.input.value || '').trim() !== '';
        const isDeficit = r.card.classList.contains('deficit');
        if (hasAmount || isDeficit) r.box.classList.add('open');
      });

      try { 
        await fn(); 
      } finally { 
        // restore box state
        MONEY_INPUTS.forEach((r, id) => {
          r.box.classList.toggle('open', !!prevOpen[id]);
        });
        exportFrame.classList.remove('exporting'); 
      }
    }

    function safeFilename(base){ return base.replace(/[\\/:*?"<>|]/g, '_').replace(/\s+/g, ' ').trim(); }


    async function renderExportCanvas(){
      // âœ… Measure exact height (avoid last-line cropping)
      const target = document.getElementById('captureArea');
      const rect = target.getBoundingClientRect();

      // Add a small safety pad at bottom in pixels (scaled later)
      const SAFE_PAD = 24;

      return await html2canvas(target, {
        backgroundColor: '#ffffff',
        scale: SCALE,
        useCORS: true,
        logging: false,

        // âœ… Force capture size (prevents cropping)
        width: Math.ceil(rect.width),
        height: Math.ceil(rect.height + SAFE_PAD),
        windowWidth: Math.ceil(rect.width),
        windowHeight: Math.ceil(rect.height + SAFE_PAD),

        // âœ… Fix overflow clipping only in the cloned DOM
        onclone: (doc) => {
          const clonedCapture = doc.getElementById('captureArea');
          if (clonedCapture) clonedCapture.style.paddingBottom = '18px';

          // Make potential clipping containers visible
          doc.querySelectorAll('.card, .grid, .export-frame').forEach(el => {
            el.style.overflow = 'visible';
          });

          // Some browsers clip input text baseline; bump line-height slightly in clone
          doc.querySelectorAll('.money-input').forEach(el => {
            el.style.lineHeight = '1.4';
            el.style.paddingBottom = '2px';
          });
        }
      });
    }


    // Export PNG
    pngBtn.addEventListener('click', () => {
      captureWithExporting(async () => {
        const canvas =  await renderExportCanvas();
        canvas.toBlob((blob) => {
          if (!blob) return;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const client = (clientName.value.trim() || 'é¸é …æˆªåœ–');
          a.href = url; a.download = `${safeFilename(client)}_${yyyymmdd}.png`; a.click();
          URL.revokeObjectURL(url);
        }, 'image/png');
      });
    });

    // Export PDF
    pdfBtn.addEventListener('click', () => {
      captureWithExporting(async () => {
        const canvas = await renderExportCanvas();
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const isLandscape = canvas.width > canvas.height;
        const pdf = new jsPDF({ orientation: isLandscape ? 'landscape' : 'portrait', unit: 'pt', format: 'a4' });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const maxW = pageW * 0.90, maxH = pageH * 0.90;
        const ratio = Math.min(maxW / canvas.width, maxH / canvas.height);
        const imgW = canvas.width * ratio, imgH = canvas.height * ratio;
        const x = (pageW - imgW) / 2, y = (pageH - imgH) / 2;
        pdf.addImage(imgData, 'PNG', x, y, imgW, imgH);
        const client = (clientName.value.trim() || 'é¸é …æˆªåœ–');
        pdf.save(`${safeFilename(client)}_${yyyymmdd}.pdf`);
      });
    });

    /* === Sidebar (hidden by default) + Save Profiles === */

    const __sidebarCSS = `
    .client-sidebar{
      position: fixed; inset: 0 auto 0 0; width: 260px;
      background:#fff; border-right:1px solid #e8eaf3;
      padding:16px 12px; overflow:auto;
      box-shadow:0 0 10px rgba(0,0,0,.06);
      transform:translateX(-100%); transition:transform .2s ease;
      z-index:9;
    }
    body.sidebar-open .client-sidebar{ transform:translateX(0); }
    
    .sidebar-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.25);
      opacity: 0;
      visibility: hidden;      /* âœ… new */
      pointer-events: none;
      transition: opacity .2s ease, visibility .2s ease;
      z-index: 8;
    }
    body.sidebar-open .sidebar-overlay{
      opacity: 1;
      visibility: visible;     /* âœ… new */
      pointer-events: auto;
    } 

    @media (max-width:480px){
      .sidebar-overlay{ background: rgba(0,0,0,.35); }
    }
    body.sidebar-open{ overflow:hidden; }
    .client-sidebar .sidebar-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:4px 8px 0;
    }
    .client-sidebar .sidebar-head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.5px;
      color:#1f2a3a;
    }
    .client-sidebar .sidebar-close{
      border:1px solid #cfd6e7;
      background:#fff;
      color:#1a2a3a;
      width:32px;
      height:32px;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
      line-height:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .client-sidebar .sidebar-close:hover{
      border-color:#c6d2f7;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .client-sidebar .search{ width:100%; padding:8px 10px; border:1px solid #cfd6e7; border-radius:8px; margin:8px 6px 12px; font-size:13px; }
    .client-list{ list-style:none; margin:0; padding:0 6px; display:grid; gap:8px; }
    .client-item{ border:1px solid #e0e3eb; border-radius:10px; padding:10px; background:#fff; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .client-item .meta{ display:flex; flex-direction:column; min-width:0; }
    .client-item .name{ font-weight:700; font-size:14px; color:#1f2a3a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .client-item .date{ font-size:12px; color:#5f6368; }
    .client-item .actions{ display:flex; gap:6px; }
    .client-item .btn-xs{ border:1px solid #cfd6e7; background:#fff; color:#1a2a3a; padding:4px 8px; border-radius:8px; font-size:12px; cursor:pointer; }
    .client-empty{ padding:10px 8px; color:#5f6368; font-size:12px; }
    @media (max-width:480px){
      .client-sidebar{ width:85vw; }
    }`;
    const styleEl = document.createElement('style');
    styleEl.textContent = __sidebarCSS;
    document.head.appendChild(styleEl);

    // Build sidebar
    const sidebar = document.createElement('aside');
    sidebar.className = 'client-sidebar';
    sidebar.setAttribute('aria-hidden', 'true');
    sidebar.innerHTML = `
      <div class="sidebar-head">
        <h2>å®¢æˆ¶åˆ—è¡¨</h2>
        <button type="button" class="sidebar-close" aria-label="é—œé–‰å´é‚Šæ¬„">âœ•</button>
      </div>
      <input type="search" class="search" placeholder="æœå°‹å§“åâ€¦" aria-label="æœå°‹å§“å" />
      <ul class="client-list" id="clientList"></ul>
      <div class="client-empty" id="clientEmpty" style="display:none;">å°šæœªå„²å­˜ä»»ä½•å®¢æˆ¶ã€‚</div>`;
    document.body.appendChild(sidebar);

    // Build overlay
    const overlay = document.createElement('div');
    overlay.className = 'sidebar-overlay';
    overlay.setAttribute('aria-hidden', 'true');
    document.body.appendChild(overlay);

    // Toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'sidebar-toggle-inline';
    toggleBtn.type = 'button';
    toggleBtn.setAttribute('aria-expanded', 'false');
    toggleBtn.setAttribute('aria-controls', 'clientList');
    toggleBtn.textContent = 'â˜° å®¢æˆ¶';

    const toggleSlot = document.querySelector('.toggle-slot');
    if (toggleSlot) toggleSlot.appendChild(toggleBtn);

    function openSidebar(){
      document.body.classList.add('sidebar-open');
      toggleBtn.setAttribute('aria-expanded', 'true');
      sidebar.setAttribute('aria-hidden', 'false');
      overlay.setAttribute('aria-hidden', 'false');
    }
    function closeSidebar(){
      if (!document.body.classList.contains('sidebar-open')) return;
      document.body.classList.remove('sidebar-open');
      toggleBtn.setAttribute('aria-expanded', 'false');
      sidebar.setAttribute('aria-hidden', 'true');
      overlay.setAttribute('aria-hidden', 'true');
    }

    toggleBtn.addEventListener('click', () => {
      if (document.body.classList.contains('sidebar-open')) closeSidebar();
      else openSidebar();
    });

    overlay.addEventListener('click', closeSidebar);
    sidebar.querySelector('.sidebar-close')?.addEventListener('click', closeSidebar);

    // Insert Save button (before PNG)
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn';
    saveBtn.type = 'button';
    saveBtn.id = 'saveBtn';
    saveBtn.textContent = 'å„²å­˜è³‡æ–™';
    pngBtn.insertAdjacentElement('beforebegin', saveBtn);

    // Profiles storage
    const PROFILES_KEY = 'fp_profiles_v1';
    function loadProfiles(){ try{ return JSON.parse(localStorage.getItem(PROFILES_KEY)) || []; }catch(e){ return []; } }
    function storeProfiles(list){ localStorage.setItem(PROFILES_KEY, JSON.stringify(list)); }

    function readState(){
      const s = {};
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        s[id] = !!card.querySelector('.check').checked;
      });
      return s;
    }

    function applyState(state){
      [...form.querySelectorAll('.card')].forEach(card => {
        const id = card.dataset.id;
        const on = !!state[id];
        const input = card.querySelector('.check');
        input.checked = on; card.classList.toggle('checked', on);
      });
      persistChecks();
    }

    function formatDT(d = new Date()){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      const hh=String(d.getHours()).padStart(2,'0'), mn=String(d.getMinutes()).padStart(2,'0');
      return `${y}/${m}/${dd} ${hh}:${mn}`;
    }

    // Save profile
    function saveProfile(){
      const name = clientName.value.trim();
      if(!name){ alert('è«‹å…ˆè¼¸å…¥å®¢æˆ¶å§“åå†å„²å­˜ã€‚'); clientName.focus(); return; }

      const profiles = loadProfiles();
      const idx = profiles.findIndex(p => p.name === name);

      const profile = {
        id: idx >= 0 ? profiles[idx].id : `p_${Date.now()}`,
        name,
        age: (clientAge.value || '').trim(),
        gender: (clientGender.value || '').trim(),
        state: readState(),
        amounts: readAmounts(),
        currencies: readCurrencies(),
        deficits: readDeficits(),
        savedAt: formatDT()
      };

      if(idx >= 0) profiles[idx] = profile; else profiles.unshift(profile);
      storeProfiles(profiles);

      // Update top fields local storage
      localStorage.setItem(KEY_NAME, name);
      localStorage.setItem(KEY_AGE, profile.age);
      localStorage.setItem(KEY_GENDER, profile.gender);

      // âœ… Also sync auto-save keys so refresh matches the latest edits
      localStorage.setItem(KEY_AMOUNTS, JSON.stringify(profile.amounts || {}));
      localStorage.setItem(KEY_CURRENCIES, JSON.stringify(profile.currencies || {}));
      localStorage.setItem(KEY_DEFICITS, JSON.stringify(profile.deficits || {}));

      renderClientList();
    }

    // Load / Delete
    function loadProfileById(id){
      const profiles = loadProfiles();
      const p = profiles.find(x => x.id === id);
      if(!p) return;

      clientName.value = p.name || '';
      localStorage.setItem(KEY_NAME, clientName.value);
      syncNameMirror();

      clientAge.value = (p.age || '');
      localStorage.setItem(KEY_AGE, clientAge.value);
      syncAgeMirror();

      clientGender.value = (p.gender || '');
      localStorage.setItem(KEY_GENDER, clientGender.value);
      syncGenderMirror();

      applyState(p.state || {});
      applyAmounts(p.amounts || {});
      applyCurrencies(p.currencies || {});
      applyDeficits(p.deficits || {});

      // âœ… Keep auto-save keys consistent with loaded profile
      localStorage.setItem(KEY_AMOUNTS, JSON.stringify(p.amounts || {}));
      localStorage.setItem(KEY_CURRENCIES, JSON.stringify(p.currencies || {}));
      localStorage.setItem(KEY_DEFICITS, JSON.stringify(p.deficits || {}));

      closeSidebar();
    }

    function deleteProfile(id){
      const profiles = loadProfiles().filter(p => p.id !== id);
      storeProfiles(profiles);
      renderClientList();
    }

    // Sidebar render
    function renderClientList(filterText = ''){
      const listEl = document.getElementById('clientList');
      const emptyEl = document.getElementById('clientEmpty');
      const profiles = loadProfiles();
      const q = filterText.trim().toLowerCase();
      const filtered = q ? profiles.filter(p => (p.name||'').toLowerCase().includes(q)) : profiles;

      listEl.innerHTML = '';
      emptyEl.style.display = filtered.length ? 'none' : 'block';

      filtered.forEach(p => {
        const li = document.createElement('li');
        li.className = 'client-item';
        li.innerHTML = `
          <div class="meta">
            <div class="name" title="${p.name}">${p.name}</div>
            <div class="date">ä¸Šæ¬¡å„²å­˜ï¼š${p.savedAt}</div>
          </div>
          <div class="actions">
            <button class="btn-xs load">è¼‰å…¥</button>
            <button class="btn-xs del" title="åˆªé™¤">åˆªé™¤</button>
          </div>`;
        li.querySelector('.load').addEventListener('click', () => loadProfileById(p.id));
        li.querySelector('.del').addEventListener('click', () => {
          if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${p.name}ã€çš„è³‡æ–™ï¼Ÿ`)){ deleteProfile(p.id); }
        });
        listEl.appendChild(li);
      });
    }

    saveBtn.addEventListener('click', saveProfile);
    sidebar.querySelector('.search').addEventListener('input', (e) => renderClientList(e.target.value));
    renderClientList();

    // Close sidebar before export & Esc
    pngBtn.addEventListener('click', closeSidebar, true);
    pdfBtn.addEventListener('click', closeSidebar, true);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });
  });
</script>
</body>
</html>



















